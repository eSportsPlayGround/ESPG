<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>eSports PlayGround | Final</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Rajdhani:wght@600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <!-- FIREBASE COMPAT -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        /* --- THEME --- */
        :root {
            --cyan: #00DFDC; --pink: #FF1744; --neon-green: #00FF7F; --yellow: #FFCB00;
            --bg-body: #050505; --bg-surface: #111111; --bg-input: #1C1C1E;
            --text-main: #FFFFFF; --text-muted: #A1A1AA; --border: #333333;
            --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
            --nav-height: 65px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: black; color: var(--text-main); font-family: 'Inter', sans-serif; height: 100dvh; width: 100vw; display: flex; justify-content: center; overflow: hidden; }
        #app-root { width: 100%; height: 100%; background: var(--bg-body); position: relative; display: flex; flex-direction: column; overflow: hidden; }
        @media (min-width: 600px) { #app-root { max-width: 500px; border-left: 1px solid #333; border-right: 1px solid #333; } }

        /* --- UI COMPONENTS --- */
        .h1 { font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 26px; text-transform: uppercase; letter-spacing: 0.5px; }
        .h2 { font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 18px; color: var(--cyan); }
        .text-sm { font-size: 13px; color: var(--text-muted); line-height: 1.4; }
        .text-xs { font-size: 11px; color: var(--text-muted); }
        .bold { font-weight: 600; }
        .hidden { display: none !important; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }

        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 700; font-size: 14px; font-family: 'Rajdhani', sans-serif; text-transform: uppercase; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.2s; }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        .btn-primary { background: var(--cyan); color: #000; box-shadow: 0 0 15px rgba(0, 223, 220, 0.2); }
        .btn-green { background: var(--neon-green); color: #000; }
        .btn-danger { background: rgba(255, 23, 68, 0.1); color: var(--pink); border: 1px solid var(--pink); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
        .btn-copy { background: rgba(0, 223, 220, 0.1); border: 1px solid var(--cyan); color: var(--cyan); padding: 4px 8px; font-size: 10px; border-radius: 6px; cursor: pointer; }

        .input-box, select { width: 100%; background: var(--bg-input); border: 1px solid var(--border); padding: 14px; border-radius: 10px; color: white; font-size: 14px; outline: none; margin-bottom: 12px; transition: 0.3s; }
        .input-box:focus { border-color: var(--cyan); }
        .input-box:disabled { opacity: 0.6; cursor: not-allowed; border-color: #333; background: #111; color: #888; }
        label { font-size: 11px; color: var(--cyan); font-weight: 700; text-transform: uppercase; margin-bottom: 4px; display: block; }

        /* --- LAYOUTS --- */
        .header { height: calc(60px + var(--safe-top)); padding: var(--safe-top) 20px 0; display: flex; align-items: center; justify-content: space-between; background: rgba(15,15,17,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); position: absolute; top: 0; width: 100%; z-index: 50; }
        .content { flex: 1; overflow-y: auto; padding: calc(70px + var(--safe-top)) 20px calc(90px + var(--safe-bottom)); scroll-behavior: smooth; }
        .bottom-nav { position: absolute; bottom: 0; width: 100%; height: calc(var(--nav-height) + var(--safe-bottom)); padding-bottom: var(--safe-bottom); background: rgba(10,10,10,0.95); border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; backdrop-filter: blur(10px); z-index: 50; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #555; font-size: 10px; cursor: pointer; transition: 0.2s; width: 60px; }
        .nav-item.active { color: var(--cyan); }
        .nav-item span { font-size: 24px; }

        .card { background: var(--bg-surface); padding: 16px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 12px; }
        .t-card { background: var(--bg-surface); border-radius: 16px; overflow: hidden; margin-bottom: 20px; border: 1px solid var(--border); position: relative; }
        .t-img { width: 100%; height: 150px; object-fit: cover; opacity: 0.9; }
        .t-body { padding: 16px; }

        /* --- MODULES --- */
        .room-box { background: rgba(0, 223, 220, 0.05); border: 1px dashed var(--cyan); border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .room-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .room-val { font-family: monospace; font-size: 16px; color: white; letter-spacing: 1px; }
        .official-tag { position: absolute; top: 12px; left: 12px; padding: 4px 8px; background: var(--yellow); color: black; font-weight: 800; font-size: 10px; border-radius: 4px; box-shadow: 0 0 10px rgba(255,203,0,0.5); z-index: 2; }
        
        .p-tabs, .admin-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 20px; overflow-x: auto; gap: 10px; padding-bottom: 5px; }
        .p-tab, .admin-tab { flex: 1; text-align: center; padding: 12px; color: var(--text-muted); cursor: pointer; font-size: 13px; font-weight: 600; white-space: nowrap; }
        .p-tab.active, .admin-tab.active { color: var(--cyan); border-bottom: 2px solid var(--cyan); }

        .menu-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-input); border-radius: 10px; margin-bottom: 8px; cursor: pointer; }
        .menu-item:active { background: #222; }
        .detail-item { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #333; }
        .detail-label { font-size: 11px; color: var(--cyan); text-transform: uppercase; font-weight: 700; margin-bottom: 4px; }
        .detail-val { font-size: 14px; color: white; word-break: break-all; }

        /* --- OVERLAYS --- */
        .auth-view { position: absolute; inset: 0; z-index: 100; background: linear-gradient(180deg, #0a0a0a 0%, #000 100%); padding: 30px; display: flex; flex-direction: column; justify-content: center; overflow-y: auto; }
        .detail-view { position: absolute; inset: 0; background: var(--bg-body); z-index: 60; display: flex; flex-direction: column; overflow-y: auto; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from{transform:translateX(100%)} to{transform:translateX(0)} }
        .detail-header { height: 250px; position: relative; }
        .detail-img { width: 100%; height: 100%; object-fit: cover; mask-image: linear-gradient(to bottom, black 60%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%); }

        .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        .st-Live { background: rgba(0,255,127,0.1); color: var(--neon-green); border: 1px solid var(--neon-green); }
        .st-Upcoming { background: rgba(0,223,220,0.1); color: var(--cyan); border: 1px solid var(--cyan); }
        .st-Completed { background: #222; color: #777; border: 1px solid #444; }

        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #18181b; color: white; padding: 12px 20px; border-radius: 30px; font-size: 13px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid var(--border); z-index: 2000; animation: fadeDown 0.3s; width: max-content; }
        @keyframes fadeDown { from{opacity:0; transform:translate(-50%, -20px)} to{opacity:1; transform:translate(-50%, 0)} }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; align-items: flex-end; backdrop-filter: blur(5px); }
        .modal-content { width: 100%; background: #121212; border-radius: 24px 24px 0 0; padding: 24px 24px calc(24px + var(--safe-bottom)); border-top: 1px solid var(--border); animation: slideUp 0.3s; max-height: 85vh; overflow-y: auto; }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        .loader { border: 3px solid #222; border-top: 3px solid var(--cyan); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fab { position: absolute; bottom: 100px; right: 20px; width: 56px; height: 56px; background: var(--cyan); border-radius: 16px; display: grid; place-items: center; color: black; box-shadow: var(--glow-cyan); z-index: 40; cursor: pointer; transition: 0.2s; }
    </style>
</head>
<body>

<div id="app-root">
    <div id="toast-area"></div>

    <!-- AUTHENTICATION -->
    <div id="view-auth" class="auth-view">
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="width: 70px; height: 70px; border: 2px solid var(--cyan); border-radius: 20px; margin: 0 auto 16px; display: grid; place-items: center; box-shadow: var(--glow-cyan);">
                <span class="material-icons-round" style="font-size: 36px; color: var(--cyan);">sports_esports</span>
            </div>
            <h1 class="h1">eSports<br><span style="color:var(--cyan)">PlayGround</span></h1>
        </div>
        <div id="form-login">
            <input type="text" id="l-user" class="input-box" placeholder="Username">
            <input type="password" id="l-pass" class="input-box" placeholder="Password">
            <button class="btn btn-primary" id="btn-login-action" onclick="auth.login()">LOGIN</button>
            <p style="text-align:center; margin-top:20px; font-size:13px; color:var(--text-muted)">New Player? <span style="color:var(--cyan); cursor:pointer" onclick="ui.toggleAuth('signup')">Create Account</span></p>
        </div>
        <div id="form-signup" class="hidden">
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn btn-outline" id="role-player" onclick="auth.setRole('player')" style="flex:1; border-color:var(--cyan); color:var(--cyan);">Player</button>
                <button class="btn btn-outline" id="role-organizer" onclick="auth.setRole('organizer')" style="flex:1;">Organizer</button>
            </div>
            <label>Country (Auto Currency)</label>
            <select id="s-country" class="input-box">
                <option value="IN">India (₹ INR)</option><option value="US">USA ($ USD)</option><option value="EU">Europe (€ EUR)</option>
                <option value="UK">UK (£ GBP)</option><option value="JP">Japan (¥ JPY)</option><option value="GL">Global ($ USD)</option>
            </select>
            <label>Details</label>
            <input type="text" id="s-name" class="input-box" placeholder="Full Name">
            <input type="text" id="s-user" class="input-box" placeholder="Username (Unique)">
            <input type="email" id="s-email" class="input-box" placeholder="Email Address">
            <input type="tel" id="s-phone" class="input-box" placeholder="Phone Number">
            <input type="password" id="s-pass" class="input-box" placeholder="Password">
            <button class="btn btn-primary" id="btn-signup-action" onclick="auth.signup()">REGISTER</button>
            <p style="text-align:center; margin-top:20px; font-size:13px; color:var(--text-muted)">Have account? <span style="color:var(--cyan); cursor:pointer" onclick="ui.toggleAuth('login')">Login</span></p>
        </div>
    </div>

    <!-- APP -->
    <div id="view-app" class="hidden" style="height:100%; display:flex; flex-direction:column;">
        <header class="header">
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="width:36px; height:36px; background:var(--cyan); border-radius:10px; display:grid; place-items:center; font-weight:700; color:black;" id="nav-av">U</div>
                <div><div class="bold" style="font-size:14px; color:white;" id="nav-user">User</div><div class="text-xs" style="color:var(--cyan);" id="nav-role">PLAYER</div></div>
            </div>
            <div style="font-family:'Rajdhani'; font-weight:700; font-size:18px; color:var(--neon-green);" id="nav-bal">0.00</div>
        </header>
        <div id="main-content" class="content"></div>
        <div id="fab" class="fab hidden" onclick="ui.router('create_match')"><span class="material-icons-round">add</span></div>
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="ui.router('home', this)"><span class="material-icons-round">grid_view</span>Home</div>
            <div class="nav-item" onclick="ui.router('wallet', this)"><span class="material-icons-round">account_balance_wallet</span>Wallet</div>
            <div class="nav-item hidden" id="menu-admin" onclick="ui.router('admin', this)"><span class="material-icons-round">admin_panel_settings</span>Admin</div>
            <div class="nav-item" onclick="ui.router('profile', this)"><span class="material-icons-round">person</span>Profile</div>
        </nav>
    </div>

    <!-- MODALS & OVERLAYS -->
    <div id="view-details" class="detail-view hidden"></div>
    <div id="modal-container"></div>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyBCkWyoKZXAP_TOaqQWdAhM_z_gr7d6H8k",
        authDomain: "esports-playground.firebaseapp.com",
        databaseURL: "https://esports-playground-default-rtdb.firebaseio.com",
        projectId: "esports-playground",
        storageBucket: "esports-playground.firebasestorage.app",
        messagingSenderId: "387918136520",
        appId: "1:387918136520:web:7aaabca5623cadd0a551fd",
        measurementId: "G-JQRJVL49V9"
    };

    try { firebase.initializeApp(firebaseConfig); var db = firebase.database(); } 
    catch (e) { alert("Firebase Error: " + e.message); }

    const state = { user: null, role: 'player' };
    const curMap = { 'IN': '₹', 'US': '$', 'EU': '€', 'UK': '£', 'JP': '¥', 'GL': '$' };
    const generateId = () => Math.floor(10000000000000 + Math.random() * 90000000000000).toString();
    const activeListeners = [];

    // --- AUTHENTICATION ---
    const auth = {
        setRole: (r) => {
            state.role = r;
            const btnP = document.getElementById('role-player'), btnO = document.getElementById('role-organizer');
            if(r === 'player') { btnP.style.borderColor = 'var(--cyan)'; btnP.style.color = 'var(--cyan)'; btnO.style.borderColor = 'var(--border)'; btnO.style.color = 'var(--text-muted)'; } 
            else { btnO.style.borderColor = 'var(--cyan)'; btnO.style.color = 'var(--cyan)'; btnP.style.borderColor = 'var(--border)'; btnP.style.color = 'var(--text-muted)'; }
        },
        signup: () => {
            const btn = document.getElementById('btn-signup-action'); btn.innerHTML = '...';
            const name = document.getElementById('s-name').value, user = document.getElementById('s-user').value.toLowerCase().trim(), pass = document.getElementById('s-pass').value;
            const country = document.getElementById('s-country').value;
            if(!name || !user || !pass) { btn.innerHTML = 'REGISTER'; return ui.toast("Fill all fields"); }
            db.ref('users/' + user).once('value').then((snap) => {
                if(snap.exists()) { btn.innerHTML = 'REGISTER'; return ui.toast("Username taken!"); }
                const newUser = { name, username: user, email: document.getElementById('s-email').value, phone: document.getElementById('s-phone').value, password: pass, role: state.role, balance: 0, kycStatus: 'none', country: country, currency: curMap[country] || '$', joinedDate: new Date().toISOString() };
                db.ref('users/' + user).set(newUser).then(() => { btn.innerHTML = 'REGISTER'; ui.toast("Created! Login."); ui.toggleAuth('login'); });
            });
        },
        login: () => {
            const btn = document.getElementById('btn-login-action'); btn.innerHTML = '...';
            const user = document.getElementById('l-user').value.toLowerCase().trim(), pass = document.getElementById('l-pass').value;
            if(user === 'esportsplayground' && pass === 'vcxz888acxz888eSPG') {
                state.user = { username: 'admin', name: 'Super Admin', role: 'admin', balance: 999999, currency: '$', email:'admin@esp.com', phone:'0000000000', kycStatus:'verified' };
                localStorage.setItem('esp_session', JSON.stringify(state.user)); ui.initApp(); return;
            }
            db.ref('users/' + user).once('value').then((snap) => {
                if (snap.exists()) {
                    const d = snap.val();
                    if(d.password === pass) {
                        if(d.isBanned) { btn.innerHTML = 'LOGIN'; return ui.toast("Account Banned"); }
                        state.user = d; localStorage.setItem('esp_session', JSON.stringify(d)); ui.initApp();
                    } else { btn.innerHTML = 'LOGIN'; ui.toast("Wrong Password"); }
                } else { btn.innerHTML = 'LOGIN'; ui.toast("User not found"); }
            }).catch(e => { btn.innerHTML = 'LOGIN'; alert("Connection Error"); });
        },
        checkSession: () => {
            const s = localStorage.getItem('esp_session');
            if(s) { const u = JSON.parse(s); if(u.role === 'admin') { state.user = u; ui.initApp(); } else { db.ref('users/' + u.username).once('value').then(snap => { if(snap.exists()) { state.user = snap.val(); ui.initApp(); } }); } }
        },
        logout: () => { localStorage.removeItem('esp_session'); location.reload(); },
        resetPassword: () => { window.location.href = `mailto:esportsplayground@outlook.com?subject=Reset Password ${state.user.username}&body=Please reset my password.`; }
    };

    // --- UI MANAGER ---
    const ui = {
        toast: (msg) => {
            const t = document.createElement('div'); t.className = 'toast'; t.innerText = msg;
            document.getElementById('toast-area').appendChild(t); setTimeout(() => t.remove(), 3000);
        },
        toggleAuth: (mode) => { document.getElementById('form-login').classList.toggle('hidden', mode !== 'login'); document.getElementById('form-signup').classList.toggle('hidden', mode !== 'signup'); },
        
        clearListeners: () => {
            activeListeners.forEach(l => l.ref.off('value', l.cb));
            activeListeners.length = 0;
        },
        addListener: (ref, callback) => {
            ref.on('value', callback);
            activeListeners.push({ ref: ref, cb: callback });
        },

        initApp: () => {
            document.getElementById('view-auth').classList.add('hidden'); document.getElementById('view-app').classList.remove('hidden');
            
            if(state.user.role !== 'admin') {
                db.ref('users/' + state.user.username).on('value', snap => {
                    if(snap.exists()) {
                        state.user = snap.val();
                        document.getElementById('nav-user').innerText = state.user.name.split(' ')[0];
                        document.getElementById('nav-av').innerText = state.user.name[0];
                        document.getElementById('nav-bal').innerText = `${state.user.currency || '$'}${state.user.balance}`;
                    }
                });
            } else {
                document.getElementById('nav-user').innerText = "Admin";
                document.getElementById('nav-av').innerText = "A";
                document.getElementById('nav-bal').innerText = "ADM";
            }

            document.getElementById('nav-role').innerText = state.user.role.toUpperCase();
            if(state.user.role === 'organizer' || state.user.role === 'admin') document.getElementById('fab').classList.remove('hidden');
            if(state.user.role === 'admin') document.getElementById('menu-admin').classList.remove('hidden');
            ui.router('home');
        },
        router: (route, navEl = null) => {
            ui.clearListeners();
            if(navEl) { document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active')); navEl.classList.add('active'); }
            const c = document.getElementById('main-content'); c.innerHTML = '<div class="loader" style="margin-top:50px;"></div>';
            if(route === 'home') logic.loadHome(c);
            if(route === 'wallet') logic.loadWallet(c);
            if(route === 'admin') logic.loadAdmin(c, 'users');
            if(route === 'profile') logic.loadProfile(c);
            if(route === 'create_match') logic.loadCreate(c);
        },
        openModal: (type, data = null) => {
            const mc = document.getElementById('modal-container');
            let content = '';
            if(type === 'kyc') {
                content = `<h2 class="h2">Global KYC</h2><p class="text-xs" style="margin-bottom:15px;">Verify identity.</p><label>Legal Name</label><input id="k-name" class="input-box"><label>Payment</label><select id="k-method" class="input-box" onchange="ui.toggleKycFields()"><option value="paypal">PayPal</option><option value="upi">UPI</option><option value="bank">Bank Transfer</option></select><div id="sec-paypal"><label>Email</label><input id="k-pp-email" class="input-box"><label>Username</label><input id="k-pp-user" class="input-box"><label>Mobile</label><input id="k-pp-mobile" class="input-box"></div><div id="sec-upi" class="hidden"><label>UPI ID</label><input id="k-upi-id" class="input-box"><label>Mobile</label><input id="k-upi-mobile" class="input-box"></div><div id="sec-bank" class="hidden"><label>Bank Name</label><input id="k-bk-name" class="input-box"><label>Acc No</label><input id="k-bk-acc" class="input-box"><label>IFSC/SWIFT</label><input id="k-bk-code" class="input-box"></div><button class="btn btn-primary" onclick="logic.submitKyc()">SUBMIT</button><button class="btn btn-outline" style="margin-top:10px;" onclick="document.querySelector('.modal').remove()">CANCEL</button>`;
            } else if (type === 'deposit') {
                const autoId = generateId(); 
                content = `<h2 class="h2" style="text-align:center;">Scan & Pay</h2><div style="text-align:center; margin:20px 0;"><img src="https://i.postimg.cc/sXtr7zzk/e-Sports-Play-Ground.png" style="width:180px; border-radius:10px; border:2px solid var(--cyan);"><div style="background:#1f1f22; padding:10px; border-radius:8px; margin-top:10px; display:flex; justify-content:space-between; align-items:center;"><span class="text-xs" style="font-family:monospace">tusharkantidasofficial@oksbi</span><span class="bold text-xs" style="color:var(--cyan); cursor:pointer;" onclick="navigator.clipboard.writeText('tusharkantidasofficial@oksbi'); alert('Copied')">COPY</span></div></div><label>Amount (${state.user.currency})</label><input type="number" id="d-amt" class="input-box"><label>System Transaction ID (Auto)</label><input type="text" id="d-utr" class="input-box" value="${autoId}" disabled style="opacity:0.7; cursor:not-allowed;"><button class="btn btn-primary" onclick="logic.submitDeposit()">VERIFY</button><button class="btn btn-outline" style="margin-top:10px;" onclick="document.querySelector('.modal').remove()">CLOSE</button>`;
            } else if (type === 'organizerReward') {
                content = `<h2 class="h2">Reward Player</h2><label>Username</label><input id="rw-user" class="input-box"><label>Amount</label><input type="number" id="rw-amt" class="input-box"><button class="btn btn-primary" onclick="logic.giveReward()">SEND</button><button class="btn btn-outline" style="margin-top:10px;" onclick="document.querySelector('.modal').remove()">CANCEL</button>`;
            } else if (type === 'roomInfo') {
                content = `<h2 class="h2">Room Settings</h2><p class="text-xs" style="margin-bottom:15px;">Visible only to joined players when LIVE.</p><label>Room ID</label><input id="r-id" class="input-box" value="${data.roomId || ''}"><label>Password</label><input id="r-pass" class="input-box" value="${data.roomPass || ''}"><button class="btn btn-primary" onclick="logic.saveRoomInfo('${data.id}')">SAVE & UPDATE</button><button class="btn btn-outline" style="margin-top:10px;" onclick="document.querySelector('.modal').remove()">CANCEL</button>`;
            } else if (type === 'report') {
                content = `<h2 class="h2">Report Issue</h2><p class="text-xs" style="margin-bottom:15px;">Paste Match ID or Transaction ID</p><label>Issue Type</label><select id="rep-type" class="input-box"><option value="match">Match / Organizer Scam</option><option value="payment">Payment Failure</option></select><label>Reference ID</label><input id="rep-id" class="input-box"><label>Description</label><input id="rep-desc" class="input-box"><button class="btn btn-primary" onclick="logic.submitReport()">SUBMIT REPORT</button><button class="btn btn-outline" style="margin-top:10px;" onclick="document.querySelector('.modal').remove()">CANCEL</button>`;
            } else if (type === 'adminUserDetail') {
                const kyc = data.kycData || { method: 'None', linked: 'N/A' };
                let kycHtml = `Method: ${kyc.method}<br>Link: ${kyc.linked}<br>`;
                if(kyc.method === 'paypal') kycHtml += `Email: ${kyc.email}<br>User: ${kyc.user}`;
                if(kyc.method === 'bank') kycHtml += `Bank: ${kyc.bank}<br>Acc: ${kyc.acc}<br>Code: ${kyc.code}`;
                
                content = `
                    <h2 class="h2">User Data: ${data.username}</h2>
                    <div style="height:350px; overflow-y:auto; margin-bottom:15px;">
                        <div class="detail-item"><div class="detail-label">Full Name</div><div class="detail-val">${data.name}</div></div>
                        <div class="detail-item"><div class="detail-label">Contact</div><div class="detail-val">${data.email}<br>${data.phone}</div></div>
                        <div class="detail-item"><div class="detail-label">Location</div><div class="detail-val">${data.country || 'N/A'} (${data.currency})</div></div>
                        <div class="detail-item"><div class="detail-label">Financial</div><div class="detail-val">${kycHtml}</div></div>
                        <label>Manage Balance</label><input type="number" id="adm-bal" class="input-box" value="${data.balance}">
                        <button class="btn btn-primary" onclick="logic.adminUpdateUser('${data.username}')">UPDATE BALANCE/ROLE</button>
                        <button class="btn btn-danger" style="margin-top:10px;" onclick="logic.adminBan('${data.username}')">DELETE USER</button>
                    </div>
                    <button class="btn btn-outline" style="margin-top:10px;" onclick="document.querySelector('.modal').remove()">CLOSE</button>`;
            } else if (type === 'editProfile') {
                content = `
                    <h2 class="h2">Edit Profile</h2>
                    <label>Full Name</label><input id="ep-name" class="input-box" value="${state.user.name}">
                    <label>Mobile</label><input id="ep-phone" class="input-box" value="${state.user.phone}">
                    <label>Email</label><input id="ep-email" class="input-box" value="${state.user.email}">
                    <button class="btn btn-primary" onclick="logic.updateProfile()">SAVE CHANGES</button>
                    <button class="btn btn-outline" style="margin-top:10px;" onclick="document.querySelector('.modal').remove()">CANCEL</button>
                `;
            }
            mc.innerHTML = `<div class="modal"><div class="modal-content">${content}</div></div>`;
        },
        toggleKycFields: () => {
            const m = document.getElementById('k-method').value;
            document.getElementById('sec-paypal').classList.toggle('hidden', m !== 'paypal');
            document.getElementById('sec-upi').classList.toggle('hidden', m !== 'upi');
            document.getElementById('sec-bank').classList.toggle('hidden', m !== 'bank');
        },
        closeDetails: () => document.getElementById('view-details').classList.add('hidden'),
        copyText: (t) => { navigator.clipboard.writeText(t); ui.toast("Copied!"); },
        toggleProfileEdit: () => {
            const inputs = document.querySelectorAll('.prof-in');
            const isDis = inputs[0].disabled;
            inputs.forEach(i => { if(i.id !== 'p-user') i.disabled = !isDis; });
            document.getElementById('btn-save-prof').classList.toggle('hidden', !isDis);
        }
    };

    const logic = {
        loadHome: (c) => {
            ui.addListener(db.ref('tournaments'), snap => {
                const arr = []; snap.forEach(i => { let t = i.val(); t.id = i.key; arr.unshift(t); });
                c.innerHTML = `<div style="margin-bottom:20px"><h1 class="h1">Live <span style="color:var(--cyan)">Arena</span></h1></div>${arr.map(t => {
                    const isOfficial = t.creatorRole === 'admin';
                    const offTag = isOfficial ? `<div class="official-tag">OFFICIAL</div>` : '';
                    return `<div class="t-card" onclick="logic.openMatch('${t.id}')">${offTag}<img src="${t.img || 'https://via.placeholder.com/500x200'}" class="t-img"><div class="t-body"><div class="flex-between"><h3 class="h2">${t.title}</h3><span class="status-badge st-${t.status}">${t.status}</span></div><p class="text-xs" style="margin-top:4px;">${t.game} • ${t.creator}</p><div class="flex-between" style="margin-top:12px; border-top:1px solid var(--border); padding-top:10px;"><div class="text-xs"><span style="color:var(--cyan)">PRIZE</span><br><span class="bold" style="font-size:16px; color:white;">${t.currency||'$'}${t.prize}</span></div><div class="text-xs" style="text-align:right">ENTRY<br><span class="bold" style="font-size:14px; color:white;">${t.currency||'$'}${t.fee}</span></div></div></div></div>`;
                }).join('')}`;
            });
        },
        loadWallet: (c) => {
            const cur = state.user.currency || '$';
            c.innerHTML = `
                <div class="card" style="text-align:center; border-color:var(--cyan); box-shadow:var(--glow-cyan);">
                    <p class="text-xs" style="letter-spacing:1px; color:var(--cyan);">TOTAL BALANCE</p>
                    <h1 style="font-size:42px; margin:10px 0;">${cur}${state.user.balance}</h1>
                    ${state.user.kycStatus !== 'verified' ? `<div style="background:rgba(255,203,0,0.1); padding:10px; border-radius:8px; border:1px solid var(--yellow); margin-bottom:10px;"><p class="text-xs" style="color:var(--yellow)">⚠️ KYC Verification Pending</p></div><button class="btn btn-primary" onclick="ui.openModal('kyc')">COMPLETE KYC</button>` : `<div style="display:flex; gap:10px;"><button class="btn btn-outline" style="border-color:var(--cyan); color:var(--cyan)" onclick="ui.openModal('deposit')">ADD MONEY</button><button class="btn btn-outline" onclick="logic.withdraw()">WITHDRAW</button></div>`}
                </div>
                ${state.user.role === 'organizer' ? `<button class="btn btn-primary" style="margin:10px 0;" onclick="ui.openModal('organizerReward')">REWARD PLAYER</button>` : ''}
                <h3 class="h2" style="margin:20px 0 10px;">History</h3><div id="txn-list">Loading...</div>
            `;
            ui.addListener(db.ref('transactions'), snap => {
                const arr = []; snap.forEach(i => { if(i.val().user === state.user.username) { let v=i.val(); v.id=i.key; arr.unshift(v); } });
                document.getElementById('txn-list').innerHTML = arr.length ? arr.map(t => `<div class="card flex-between" style="padding:12px;"><div><div class="bold text-sm" style="color:white;">${t.type.toUpperCase()}</div><div class="text-xs" style="font-family:monospace; color:var(--text-muted)">ID: ${t.id}</div></div><div style="text-align:right"><div class="bold text-sm">${cur}${t.amount}</div><div class="text-xs" style="color:${t.status==='success'?'var(--neon-green)':(t.status==='rejected'?'var(--pink)':'var(--yellow)')}">${t.status}</div></div></div>`).join('') : '<p class="text-sm">No transactions.</p>';
            });
        },
        loadProfile: (c) => {
             // Handle Admin
             if(state.user.role === 'admin') {
                 c.innerHTML = `<h2 class="h1" style="margin-bottom:20px;">Admin Profile</h2><div class="card"><p class="bold">Super Admin</p><p class="text-xs">System Access Level: 10</p></div><button class="btn btn-danger" onclick="auth.logout()">LOGOUT</button>`;
                 return;
             }
             // Get latest user data
             ui.addListener(db.ref('users/' + state.user.username), snap => {
                 if(!snap.exists()) return;
                 state.user = snap.val();
                 // Matches Joined Count
                 db.ref('tournaments').once('value').then(tsnap => {
                     let joined = 0; tsnap.forEach(t => { if(t.val().participants && t.val().participants[state.user.username]) joined++; });
                     
                     c.innerHTML = `
                        <h2 class="h1" style="margin-bottom:20px;">Profile</h2>
                        <div class="card" style="border:1px solid var(--cyan); box-shadow:var(--glow-cyan); background:linear-gradient(135deg, #111 0%, #002 100%);">
                            <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                                <div style="width:60px; height:60px; background:var(--cyan); border-radius:15px; color:black; display:grid; place-items:center; font-size:24px; font-weight:800;">${state.user.name[0]}</div>
                                <div><div class="h2" style="margin:0; color:white;">${state.user.name}</div><div class="text-xs">@${state.user.username}</div>${state.user.kycStatus==='verified' ? '<span style="color:var(--neon-green); font-size:10px; font-weight:700;">VERIFIED ✓</span>' : '<span style="color:var(--pink); font-size:10px;">UNVERIFIED</span>'}</div>
                            </div>
                            <div class="flex-between" style="background:#000; padding:10px; border-radius:8px;">
                                <div style="text-align:center;"><div class="bold text-sm">${joined}</div><div class="text-xs">Joined</div></div>
                                <div style="text-align:center;"><div class="bold text-sm">${state.user.currency}${state.user.balance}</div><div class="text-xs">Wallet</div></div>
                                <div style="text-align:center;"><div class="bold text-sm">${state.user.role}</div><div class="text-xs">Role</div></div>
                            </div>
                        </div>
                        <div class="settings-group">
                            <div class="menu-item" onclick="ui.openModal('editProfile')"><div class="menu-label"><span class="material-icons-round" style="color:var(--cyan)">edit</span> Edit Details</div><span class="material-icons-round" style="color:#666">chevron_right</span></div>
                            <div class="menu-item" onclick="ui.openModal('kyc')"><div class="menu-label"><span class="material-icons-round" style="color:var(--neon-green)">verified</span> KYC Verification</div><span class="material-icons-round" style="color:#666">chevron_right</span></div>
                            <div class="menu-item" onclick="ui.openModal('report')"><div class="menu-label"><span class="material-icons-round" style="color:var(--yellow)">report</span> Report Issue</div><span class="material-icons-round" style="color:#666">chevron_right</span></div>
                            <div class="menu-item" onclick="auth.resetPassword()"><div class="menu-label"><span class="material-icons-round" style="color:var(--text-muted)">lock</span> Reset Password</div><span class="material-icons-round" style="color:#666">chevron_right</span></div>
                            <div class="menu-item" style="color:var(--pink)" onclick="auth.logout()"><div class="menu-label"><span class="material-icons-round">logout</span> Logout</div></div>
                        </div>
                        <div class="p-tabs"><div class="p-tab active" onclick="logic.renderHistory('Live')">Live</div><div class="p-tab" onclick="logic.renderHistory('Upcoming')">Upcoming</div><div class="p-tab" onclick="logic.renderHistory('Completed')">Completed</div></div>
                        <div id="hist-list">Loading...</div>
                     `;
                     logic.renderHistory('Live');
                 });
             });
        },
        renderHistory: (filter) => {
            document.querySelectorAll('.p-tab').forEach(e => { e.classList.toggle('active', e.innerText === filter) });
            db.ref('tournaments').once('value').then(tsnap => {
                const h = [];
                tsnap.forEach(t => { const v = t.val(); v.id = t.key; if(v.participants && v.participants[state.user.username] && v.status === filter) h.push(v); });
                document.getElementById('hist-list').innerHTML = h.length ? h.map(x => `<div class="card" onclick="logic.openMatch('${x.id}')"><div class="bold text-sm">${x.title}</div><div class="text-xs">Prize: ${x.currency||'$'}${x.prize}</div></div>`).join('') : '<p class="text-sm">No matches found.</p>';
            });
        },
        loadAdmin: (c, tab) => {
            if(state.user.role !== 'admin') return;
            const tabs = ['users', 'finance', 'kyc', 'reports'];
            const tabUI = tabs.map(t => `<div class="admin-tab ${t===tab?'active':''}" onclick="logic.loadAdmin(document.getElementById('main-content'), '${t}')">${t.toUpperCase()}</div>`).join('');
            
            c.innerHTML = `
                <h2 class="h1" style="margin-bottom:20px;">Admin</h2>
                <button class="btn btn-primary" style="margin-bottom:15px;" onclick="ui.router('create_match')">HOST OFFICIAL MATCH</button>
                <div class="admin-tabs">${tabUI}</div>
                <div id="adm-content"><div class="loader"></div></div>
            `;
            
            const cont = document.getElementById('adm-content');
            if(tab === 'users') {
                ui.addListener(db.ref('users'), snap => {
                    let html = `<div class="card"><div style="display:flex; gap:10px;"><input id="adm-search" class="input-box" placeholder="Search Username" style="margin-bottom:0;"><button class="btn btn-primary" style="width:auto;" onclick="logic.adminSearchUser()">GO</button></div></div>`;
                    snap.forEach(u => { 
                        const v = u.val(); 
                        if(v.username !== 'admin' && v.role !== 'admin' && v.username !== 'esportsplayground') {
                            html += `<div class="card flex-between"><div><div class="bold">${v.name}</div><div class="text-xs">@${v.username} | Bal: ${v.balance}</div></div><button class="btn btn-outline" style="padding:6px 12px; font-size:11px;" onclick='ui.openModal("adminUserDetail", ${JSON.stringify(v)})'>VIEW DATA</button></div>`;
                        }
                    });
                    cont.innerHTML = html;
                });
            } else if (tab === 'finance') {
                ui.addListener(db.ref('transactions').limitToLast(50), snap => {
                    let html = '';
                    snap.forEach(t => { const v = t.val(); v.id = t.key; if(v.status === 'pending') html += `<div class="card"><div class="flex-between"><span class="bold text-sm">${v.user}</span><span class="text-xs">${v.type}</span></div><div class="flex-between" style="margin:5px 0;"><span class="h2">Amt: ${v.amount}</span><span class="text-xs">ID:${v.id}</span></div><div style="display:flex; gap:10px;"><button class="btn btn-green" style="padding:8px; font-size:12px;" onclick="logic.adminTxn('${v.id}','approve','${v.user}',${v.amount},'${v.type}')">APPROVE</button><button class="btn btn-danger" style="padding:8px; font-size:12px;" onclick="logic.adminTxn('${v.id}','reject','${v.user}',${v.amount},'${v.type}')">REJECT</button></div></div>`; });
                    cont.innerHTML = html || '<p>No pending finance.</p>';
                });
            } else if (tab === 'kyc') {
                ui.addListener(db.ref('users').orderByChild('kycStatus').equalTo('pending'), snap => {
                    let html = '';
                    snap.forEach(u => { const v = u.val(); html += `<div class="card"><div class="bold text-sm">${v.name} (@${v.username})</div><div class="text-xs" style="margin:5px 0; color:var(--text-muted);">Method: ${v.kycData.method}</div><button class="btn btn-primary" style="padding:8px; font-size:12px;" onclick='ui.openModal("adminUserDetail", ${JSON.stringify(v)})'>REVIEW DATA</button></div>`; });
                    cont.innerHTML = html || '<p>No pending KYC.</p>';
                });
            } else if (tab === 'reports') {
                ui.addListener(db.ref('reports'), snap => {
                    let html = '';
                    snap.forEach(r => { const v = r.val(); v.id = r.key; html += `<div class="card"><div class="bold text-sm text-pink">Type: ${v.type}</div><div class="text-xs">Ref: ${v.refId}<br>By: ${v.by}<br>Desc: ${v.desc}</div><button class="btn btn-outline" style="margin-top:5px; padding:6px;" onclick="logic.delReport('${v.id}')">RESOLVE</button></div>`; });
                    cont.innerHTML = html || '<p>No reports.</p>';
                });
            }
        },
        loadCreate: (c) => {
            const cur = state.user.currency || '$';
            c.innerHTML = `<h2 class="h1" style="margin-bottom:20px;">Host Match</h2><label>Banner URL</label><input id="c-img" class="input-box" placeholder="https://..."><label>Title</label><input id="c-title" class="input-box"><label>Game</label><input id="c-game" class="input-box"><label>Rules</label><input id="c-desc" class="input-box"><div style="display:flex; gap:10px;"><div style="flex:1"><label>Fee (${cur})</label><input type="number" id="c-fee" class="input-box"></div><div style="flex:1"><label>Prize (${cur})</label><input type="number" id="c-prize" class="input-box"></div></div><label>Max Players</label><input type="number" id="c-max" class="input-box" value="100"><label>Status</label><select id="c-status" class="input-box"><option>Upcoming</option><option>Live</option></select><button class="btn btn-primary" onclick="logic.createMatch()">PUBLISH</button>`;
        },
        // --- ACTIONS & ROOM LOGIC ---
        saveRoomInfo: (id) => {
            const rid = document.getElementById('r-id').value, rpass = document.getElementById('r-pass').value;
            db.ref('tournaments/' + id).update({ roomId: rid, roomPass: rpass });
            ui.toast("Room Updated"); document.querySelector('.modal').remove(); logic.openMatch(id);
        },
        submitReport: () => {
            const type = document.getElementById('rep-type').value, id = document.getElementById('rep-id').value, desc = document.getElementById('rep-desc').value;
            if(!id || !desc) return ui.toast("Fill details");
            db.ref('reports').push({ type, refId: id, desc, by: state.user.username, date: new Date().toISOString() });
            ui.toast("Report Sent"); document.querySelector('.modal').remove();
        },
        delReport: (id) => { db.ref('reports/' + id).remove(); },
        updateProfile: () => {
            const updates = { name: document.getElementById('ep-name').value, phone: document.getElementById('ep-phone').value, email: document.getElementById('ep-email').value };
            db.ref('users/' + state.user.username).update(updates); state.user = { ...state.user, ...updates }; ui.toast("Updated"); document.querySelector('.modal').remove(); ui.router('profile');
        },
        adminUpdateUser: (u) => {
            const bal = parseFloat(document.getElementById('adm-bal').value);
            db.ref('users/' + u).update({ balance: bal });
            ui.toast("Updated"); document.querySelector('.modal').remove();
        },
        submitKyc: () => {
            const m = document.getElementById('k-method').value;
            let data = { method: m };
            if (m === 'paypal') { data.email = document.getElementById('k-pp-email').value; data.user = document.getElementById('k-pp-user').value; data.mobile = document.getElementById('k-pp-mobile').value; }
            else if (m === 'upi') { data.upi = document.getElementById('k-upi-id').value; data.mobile = document.getElementById('k-upi-mobile').value; }
            else { data.bank = document.getElementById('k-bk-name').value; data.acc = document.getElementById('k-bk-acc').value; data.code = document.getElementById('k-bk-code').value; }
            data.linked = data.email || data.upi || data.acc;
            db.ref('users/' + state.user.username).update({ kycStatus: 'pending', kycData: data }); state.user.kycStatus = 'pending'; ui.toast("KYC Submitted"); document.querySelector('.modal').remove(); ui.router('wallet');
        },
        submitDeposit: () => {
            const amt = parseFloat(document.getElementById('d-amt').value), utr = document.getElementById('d-utr').value; // Auto-Generated UTR
            if(!amt || !utr) return ui.toast("Fill details");
            db.ref('transactions/' + utr).set({ user: state.user.username, type: 'deposit', amount: amt, utr: 'Auto-Gen', status: 'pending', date: new Date().toISOString() }); ui.toast("Sent!"); document.querySelector('.modal').remove();
        },
        withdraw: () => {
            const amt = parseFloat(prompt("Amount:")); if(!amt || amt > state.user.balance) return ui.toast("Invalid Amount");
            const newBal = state.user.balance - amt; db.ref('users/' + state.user.username).update({ balance: newBal }); state.user.balance = newBal;
            const txnId = generateId();
            db.ref('transactions/' + txnId).set({ user: state.user.username, type: 'withdraw', amount: amt, utr: 'Requested', status: 'pending', date: new Date().toISOString() }); ui.router('wallet'); ui.toast("Requested");
        },
        createMatch: () => {
            const cur = state.user.currency || '$';
            const m = { 
                title: document.getElementById('c-title').value, game: document.getElementById('c-game').value, 
                img: document.getElementById('c-img').value, desc: document.getElementById('c-desc').value, 
                fee: parseInt(document.getElementById('c-fee').value), prize: parseInt(document.getElementById('c-prize').value), 
                maxPlayers: parseInt(document.getElementById('c-max').value),
                status: document.getElementById('c-status').value, creator: state.user.username, creatorRole: state.user.role, 
                currency: cur, participants: {} 
            };
            const matchId = generateId();
            db.ref('tournaments/' + matchId).set(m); ui.toast("Published"); ui.router('home');
        },
        openMatch: (id) => {
            // Using .on here to catch live room updates
            ui.addListener(db.ref('tournaments/' + id), snap => {
                const t = snap.val(); const v = document.getElementById('view-details'); v.classList.remove('hidden');
                const parts = t.participants ? Object.keys(t.participants) : [];
                const isJoined = parts.includes(state.user.username), isOwner = state.user.username === t.creator || state.user.role === 'admin';
                const cur = t.currency || '$';
                const isFull = parts.length >= (t.maxPlayers || 100);
                const isOfficial = t.creatorRole === 'admin';
                
                let roomHtml = '';
                if(isJoined && t.roomId) {
                    roomHtml = `<div class="room-box"><div class="text-xs" style="color:var(--cyan); margin-bottom:10px;">SECRET ROOM DETAILS</div><div class="room-row"><span>ID:</span><span class="room-val">${t.roomId}</span><button class="btn-copy" onclick="ui.copyText('${t.roomId}')">COPY</button></div><div class="room-row"><span>PASS:</span><span class="room-val">${t.roomPass}</span><button class="btn-copy" onclick="ui.copyText('${t.roomPass}')">COPY</button></div></div>`;
                } else if(isJoined && !t.roomId) { roomHtml = `<div class="card" style="border:1px dashed #444; color:#777; text-align:center; font-size:12px;">Room info appears when LIVE.</div>`; }

                const matchIdDisplay = `<div style="background:#222; padding:10px; border-radius:8px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;"><span class="text-xs text-muted">Match ID: ${id}</span><button class="btn-copy" onclick="ui.copyText('${id}')">COPY</button></div>`;

                v.innerHTML = `
                    <div style="position:fixed; top:20px; left:20px; z-index:70; background:rgba(0,0,0,0.6); padding:8px; border-radius:50%; cursor:pointer;" onclick="ui.closeDetails()"><span class="material-icons-round" style="color:white;">arrow_back</span></div>
                    <div class="detail-header">${isOfficial ? `<div class="official-tag">OFFICIAL</div>` : ''}<img src="${t.img || 'https://via.placeholder.com/500x300'}" class="detail-img"><div style="position:absolute; bottom:20px; left:20px;"><span class="status-badge st-${t.status}">${t.status}</span><h1 class="h1" style="margin-top:5px; text-shadow:0 2px 4px rgba(0,0,0,0.8);">${t.title}</h1></div></div>
                    <div style="padding:20px; padding-bottom:100px;">
                        ${matchIdDisplay}
                        <div class="flex-between" style="margin-bottom:20px;"><div class="text-xs">Organizer: <span class="bold" style="color:white">${t.creator}</span></div></div>
                        ${roomHtml}
                        <p class="text-sm" style="color:white; margin-bottom:20px;">${t.desc || 'No rules.'}</p>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;"><div class="card" style="text-align:center;"><div class="text-xs">ENTRY</div><div class="bold" style="color:var(--cyan)">${cur}${t.fee}</div></div><div class="card" style="text-align:center;"><div class="text-xs">PRIZE</div><div class="bold" style="color:var(--neon-green)">${cur}${t.prize}</div></div></div>
                        <h3 class="h2">Participants (${parts.length}/${t.maxPlayers || '∞'})</h3>
                        <div style="margin-top:10px;">${parts.length ? parts.map(p => `<div style="padding:8px; border-bottom:1px solid #222; font-size:14px;">${p}</div>`).join('') : '<p class="text-xs">No participants.</p>'}</div>
                        ${isOwner ? `<hr style="border:0; border-top:1px solid #333; margin:20px 0;"><label>Admin Control</label><div style="display:flex; gap:10px; margin-bottom:10px;"><button class="btn btn-outline" onclick="logic.updateMatchStatus('${id}', 'Live')">Live</button><button class="btn btn-outline" onclick="logic.updateMatchStatus('${id}', 'Completed')">End</button></div><button class="btn btn-primary" style="margin-bottom:10px;" onclick="ui.openModal('roomInfo', {id:'${id}', roomId:'${t.roomId||''}', roomPass:'${t.roomPass||''}'})">UPDATE ROOM ID/PASS</button><button class="btn btn-danger" onclick="logic.deleteMatch('${id}')">DELETE MATCH</button>`:''}
                    </div>
                    <div style="position:fixed; bottom:0; width:100%; padding:20px; background:rgba(10,10,10,0.95); border-top:1px solid var(--border); max-width:500px;">
                        ${isJoined ? `<button class="btn btn-danger" onclick="logic.joinMatch('${id}', ${t.fee}, false, '${t.creator}')">LEAVE MATCH</button>` : 
                          (isFull ? `<button class="btn btn-grey">MATCH FULL</button>` : `<button class="btn btn-green" onclick="logic.joinMatch('${id}', ${t.fee}, true, '${t.creator}', ${t.maxPlayers}, ${parts.length})">JOIN MATCH (${cur}${t.fee})</button>`)
                        }
                    </div>
                `;
            });
        },
        joinMatch: (id, fee, joining, creatorId, max, current) => {
            if(joining) {
                if(current >= max) return ui.toast("Match Full");
                if(state.user.balance < fee) return ui.toast("Low Balance");
                if(!confirm(`Join for ${fee}?`)) return;
                const playerBal = state.user.balance - fee;
                db.ref('users/' + state.user.username).update({ balance: playerBal }); state.user.balance = playerBal;
                db.ref('users/' + creatorId).once('value').then(s => { if(s.exists()) db.ref('users/' + creatorId).update({ balance: s.val().balance + fee }); });
                db.ref(`tournaments/${id}/participants/${state.user.username}`).set(true);
                const txnId = generateId();
                db.ref('transactions/' + txnId).set({ user: state.user.username, type: 'match_join', amount: fee, matchId: id, status: 'success', date: new Date().toISOString() });
                ui.toast("Joined!");
            } else { if(!confirm("Leave?")) return; db.ref(`tournaments/${id}/participants/${state.user.username}`).remove(); ui.toast("Left"); }
            ui.closeDetails(); ui.router('home');
        },
        adminSearchUser: (usernameOverride) => {
            const u = usernameOverride || document.getElementById('adm-search').value.toLowerCase().trim();
            db.ref('users/' + u).once('value').then(s => { if(s.exists()) ui.openModal('adminUserDetail', s.val()); else ui.toast("Not found"); });
        },
        adminUpdateUser: (u) => {
            const bal = parseFloat(document.getElementById('adm-bal').value);
            db.ref('users/' + u).update({ balance: bal });
            ui.toast("Updated"); document.querySelector('.modal').remove();
        },
        adminBan: (u) => { if(confirm("Delete User?")) { db.ref('users/' + u).remove(); ui.toast("Deleted"); document.querySelector('.modal').remove(); } },
        adminTxn: (id, act, u, amt, type) => {
            db.ref('users/' + u).once('value').then(s => {
                const c = s.val().balance;
                if(act === 'approve' && type === 'deposit') db.ref('users/' + u).update({ balance: c + amt });
                if(act === 'reject' && type === 'withdraw') db.ref('users/' + u).update({ balance: c + amt });
                db.ref('transactions/' + id).update({ status: act === 'approve' ? 'success' : 'rejected' });
                ui.router('admin', 'finance');
            });
        },
        adminKyc: (u) => { db.ref('users/'+u).update({kycStatus:'verified'}); ui.router('admin', 'kyc'); },
        updateMatchStatus: (id, s) => { db.ref('tournaments/' + id).update({ status: s }); ui.closeDetails(); ui.router('home'); },
        deleteMatch: (id) => { if(confirm("Delete?")) { db.ref('tournaments/' + id).remove(); ui.closeDetails(); ui.router('home'); } },
        giveReward: () => {
            const u = document.getElementById('rw-user').value.toLowerCase().trim(), amt = parseFloat(document.getElementById('rw-amt').value);
            if(!u || !amt) return ui.toast("Invalid details");
            db.ref('users/' + u).once('value').then(s => { if(s.exists()) { db.ref('users/' + u).update({ balance: s.val().balance + amt }); ui.toast("Sent!"); document.querySelector('.modal').remove(); } else ui.toast("User not found"); });
        }
    };

    window.onload = auth.checkSession;
</script>
</body>
</html>