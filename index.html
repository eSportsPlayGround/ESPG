<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>eSports PlayGround</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Rajdhani:wght@600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <!-- FIREBASE COMPAT -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        /* --- THEME --- */
        :root {
            --cyan: #00DFDC; --pink: #FF1744; --neon-green: #00FF7F; --yellow: #FFCB00;
            --bg-body: #050505; --bg-surface: #111111; --bg-input: #1C1C1E;
            --text-main: #FFFFFF; --text-muted: #A1A1AA; --border: #333333;
            --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
            --nav-height: 65px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: black; color: var(--text-main); font-family: 'Inter', sans-serif; height: 100dvh; width: 100vw; display: flex; justify-content: center; overflow: hidden; }
        #app-root { width: 100%; height: 100%; background: var(--bg-body); position: relative; display: flex; flex-direction: column; overflow: hidden; }
        @media (min-width: 600px) { #app-root { max-width: 500px; border-left: 1px solid #333; border-right: 1px solid #333; } }

        /* --- TYPOGRAPHY --- */
        .h1 { font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 26px; text-transform: uppercase; letter-spacing: 0.5px; }
        .h2 { font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 18px; color: var(--cyan); }
        .text-sm { font-size: 13px; color: var(--text-muted); line-height: 1.4; }
        .text-xs { font-size: 11px; color: var(--text-muted); }
        .bold { font-weight: 600; }
        .hidden { display: none !important; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }

        /* --- UI ELEMENTS --- */
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 700; font-size: 14px; font-family: 'Rajdhani', sans-serif; text-transform: uppercase; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.2s; }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        .btn-primary { background: var(--cyan); color: #000; box-shadow: 0 0 15px rgba(0, 223, 220, 0.2); }
        .btn-green { background: var(--neon-green); color: #000; }
        .btn-danger { background: rgba(255, 23, 68, 0.1); color: var(--pink); border: 1px solid var(--pink); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
        .btn-copy { background: rgba(0, 223, 220, 0.1); border: 1px solid var(--cyan); color: var(--cyan); padding: 4px 8px; font-size: 10px; border-radius: 6px; cursor: pointer; }

        .input-box, select, textarea { width: 100%; background: var(--bg-input); border: 1px solid var(--border); padding: 14px; border-radius: 10px; color: white; font-size: 14px; outline: none; margin-bottom: 12px; transition: 0.3s; font-family: 'Inter', sans-serif; }
        .input-box:focus { border-color: var(--cyan); }
        .input-box:disabled { opacity: 0.6; cursor: not-allowed; border-color: #333; background: #111; color: #888; }
        label { font-size: 11px; color: var(--cyan); font-weight: 700; text-transform: uppercase; margin-bottom: 4px; display: block; }

        /* --- CUSTOM SELECT STYLES --- */
        .select-trigger { cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .select-option { padding: 16px 0; border-bottom: 1px solid #222; color: #888; font-weight: 500; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .select-option:active { background: #1a1a1a; }
        .select-option.selected { color: var(--cyan); font-weight: 700; }
        .select-option:last-child { border-bottom: none; }

        /* --- LAYOUTS --- */
        .header { height: calc(60px + var(--safe-top)); padding: var(--safe-top) 20px 0; display: flex; align-items: center; justify-content: space-between; background: rgba(18,18,18,0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); position: absolute; top: 0; width: 100%; z-index: 50; }
        .content { flex: 1; overflow-y: auto; padding: calc(70px + var(--safe-top)) 20px calc(90px + var(--safe-bottom)); scroll-behavior: smooth; }
        .bottom-nav { position: absolute; bottom: 0; width: 100%; height: calc(var(--nav-height) + var(--safe-bottom)); padding-bottom: var(--safe-bottom); background: rgba(10,10,10,0.95); border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; backdrop-filter: blur(10px); z-index: 50; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #555; font-size: 10px; cursor: pointer; transition: 0.2s; width: 60px; }
        .nav-item.active { color: var(--cyan); }
        .nav-item span { font-size: 24px; }

        .card { background: var(--bg-surface); padding: 16px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 12px; }
        .t-card { background: var(--bg-surface); border-radius: 16px; overflow: hidden; margin-bottom: 20px; border: 1px solid var(--border); position: relative; }
        .t-img { width: 100%; height: 150px; object-fit: cover; opacity: 0.9; }
        .t-body { padding: 16px; }

        /* --- SEARCH & FILTER --- */
        .search-container { padding-bottom: 10px; background: var(--bg-body); position: sticky; top: 0; z-index: 40; }
        .search-bar { display: flex; align-items: center; background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px; padding: 12px; gap: 10px; margin-bottom: 12px; }
        .search-input { background: transparent; border: none; outline: none; color: white; width: 100%; font-size: 14px; font-family: 'Inter', sans-serif; }
        .filter-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
        .filter-scroll::-webkit-scrollbar { display: none; }
        .filter-chip { padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; border: 1px solid var(--border); color: var(--text-muted); background: var(--bg-surface); cursor: pointer; white-space: nowrap; transition: 0.2s; }
        .filter-chip.active { background: var(--cyan); color: black; border-color: var(--cyan); box-shadow: 0 0 10px rgba(0,223,220,0.3); }

        /* --- GAME SLIDER --- */
        .game-scroll { display: flex; overflow-x: auto; gap: 12px; margin-bottom: 20px; padding: 5px 0 15px 0; scroll-behavior: smooth; }
        .game-scroll::-webkit-scrollbar { display: none; }
        .game-card { flex: 0 0 auto; width: 100px; height: 177px; border-radius: 12px; overflow: hidden; position: relative; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; background: #1a1a1a; }
        .game-card.active { border: 2px solid var(--cyan); box-shadow: 0 0 15px rgba(0,223,220,0.3); transform: scale(1.03); }
        .game-card img { width: 100%; height: 100%; object-fit: cover; }
        .game-name { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(transparent, black); padding: 40px 5px 10px; text-align: center; font-size: 12px; font-weight: 700; color: white; text-shadow: 0 2px 4px black; }

        /* --- NOTIFICATION DOT --- */
        .notif-icon { position: relative; cursor: pointer; }
        .notif-dot { position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: var(--pink); border-radius: 50%; display: none; }

        /* --- MODULES --- */
        .room-box { background: rgba(0, 223, 220, 0.05); border: 1px dashed var(--cyan); border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .room-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .room-val { font-family: monospace; font-size: 16px; color: white; letter-spacing: 1px; }
        .official-tag { position: absolute; top: 12px; left: 12px; padding: 4px 8px; background: var(--yellow); color: black; font-weight: 800; font-size: 10px; border-radius: 4px; box-shadow: 0 0 10px rgba(255,203,0,0.5); z-index: 2; }
        
        .p-tabs, .admin-tabs, .match-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 20px; overflow-x: auto; gap: 10px; padding-bottom: 5px; }
        .p-tab, .admin-tab, .m-tab { flex: 1; text-align: center; padding: 12px; color: var(--text-muted); cursor: pointer; font-size: 13px; font-weight: 600; white-space: nowrap; }
        .p-tab.active, .admin-tab.active, .m-tab.active { color: var(--cyan); border-bottom: 2px solid var(--cyan); }

        .settings-group { margin-bottom: 20px; border: 1px solid var(--border); border-radius: 16px; overflow: hidden; background: var(--bg-surface); }
        .menu-item { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid #222; cursor: pointer; transition: 0.2s; background: var(--bg-surface); }
        .menu-item:active { background: #1a1a1a; }
        .menu-label { display: flex; align-items: center; gap: 14px; font-size: 15px; font-weight: 500; color: white; }
        
        /* Leaderboard Specifics */
        .podium-container { display: flex; justify-content: center; align-items: flex-end; gap: 10px; margin: 30px 0 40px; }
        .podium-item { display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; }
        .podium-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #333; margin-bottom: -10px; z-index: 2; background: #222; display:grid; place-items:center; font-weight:800; }
        .podium-bar { width: 70px; border-radius: 10px 10px 0 0; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 10px; font-weight: 800; color: black; font-family: 'Rajdhani'; font-size: 24px; position: relative; }
        .rank-1 .podium-bar { height: 140px; background: linear-gradient(to top, #FFCB00, #FFF59D); box-shadow: 0 0 20px rgba(255, 203, 0, 0.3); }
        .rank-1 .podium-avatar { border-color: #FFCB00; width: 80px; height: 80px; }
        .rank-2 .podium-bar { height: 100px; background: linear-gradient(to top, #C0C0C0, #E0E0E0); }
        .rank-2 .podium-avatar { border-color: #C0C0C0; }
        .rank-3 .podium-bar { height: 80px; background: linear-gradient(to top, #CD7F32, #E0AB7F); }
        .rank-3 .podium-avatar { border-color: #CD7F32; }
        .leader-row { display: flex; justify-content: space-between; padding: 16px; border-bottom: 1px solid #222; align-items: center; background:var(--bg-surface); margin-bottom:8px; border-radius:12px; }
        .leader-rank { width: 30px; font-weight: 700; color: var(--cyan); font-family: 'Rajdhani'; font-size: 18px; }

        .detail-item { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #333; }
        .detail-label { font-size: 11px; color: var(--cyan); text-transform: uppercase; font-weight: 700; margin-bottom: 4px; }
        .detail-val { font-size: 14px; color: white; word-break: break-all; }

        /* --- ASSETS --- */
        .asset-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; max-height: 300px; overflow-y: auto; margin-bottom: 15px; }
        .asset-card { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; position: relative; cursor: pointer; transition: 0.2s; aspect-ratio: 9/16; }
        .asset-card.selected { border: 2px solid var(--cyan); box-shadow: 0 0 15px rgba(0,223,220,0.3); }
        .asset-img { width: 100%; height: 100%; object-fit: cover; }
        .asset-name { position: absolute; bottom: 0; width: 100%; padding: 8px; text-align: center; font-size: 12px; font-weight: 700; background: rgba(0,0,0,0.8); color: white; }

        /* --- OVERLAYS --- */
        .auth-view { position: absolute; inset: 0; z-index: 100; background: linear-gradient(180deg, #0a0a0a 0%, #000 100%); padding: 30px; display: flex; flex-direction: column; justify-content: center; overflow-y: auto; }
        .detail-view { position: absolute; inset: 0; background: var(--bg-body); z-index: 60; display: flex; flex-direction: column; overflow-y: auto; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from{transform:translateX(100%)} to{transform:translateX(0)} }
        .detail-header { height: 250px; position: relative; }
        .detail-img { width: 100%; height: 100%; object-fit: cover; mask-image: linear-gradient(to bottom, black 60%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%); }

        .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        .st-Live { background: rgba(0,255,127,0.1); color: var(--neon-green); border: 1px solid var(--neon-green); }
        .st-Upcoming { background: rgba(0,223,220,0.1); color: var(--cyan); border: 1px solid var(--cyan); }
        .st-Completed { background: #222; color: #777; border: 1px solid #444; }

        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #18181b; color: white; padding: 12px 20px; border-radius: 30px; font-size: 13px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid var(--border); z-index: 2000; animation: fadeDown 0.3s; width: max-content; }
        @keyframes fadeDown { from{opacity:0; transform:translate(-50%, -20px)} to{opacity:1; transform:translate(-50%, 0)} }
        
        /* --- PROFESSIONAL MODAL --- */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: flex; align-items: flex-end; backdrop-filter: blur(8px); transition: 0.3s; }
        .modal-content { width: 100%; background: #121212; border-radius: 24px 24px 0 0; padding: 10px 24px calc(24px + var(--safe-bottom)); border-top: 1px solid #333; box-shadow: 0 -10px 40px rgba(0,0,0,0.5); animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); max-height: 85vh; overflow-y: auto; position: relative; }
        .modal-handle { width: 40px; height: 5px; background: #333; border-radius: 10px; margin: 0 auto 20px; }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        
        .loader { border: 3px solid #222; border-top: 3px solid var(--cyan); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fab { position: absolute; bottom: 100px; right: 20px; width: 56px; height: 56px; background: var(--cyan); border-radius: 16px; display: grid; place-items: center; color: black; box-shadow: var(--glow-cyan); z-index: 40; cursor: pointer; transition: 0.2s; }
    </style>
</head>
<body>

<div id="app-root">
    <div id="toast-area"></div>

    <!-- AUTHENTICATION -->
    <div id="view-auth" class="auth-view">
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="width: 70px; height: 70px; border: 2px solid var(--cyan); border-radius: 20px; margin: 0 auto 16px; display: grid; place-items: center; box-shadow: var(--glow-cyan);">
                <span class="material-icons-round" style="font-size: 36px; color: var(--cyan);">sports_esports</span>
            </div>
            <h1 class="h1">eSports<br><span style="color:var(--cyan)">PlayGround</span></h1>
        </div>
        <div id="form-login">
            <input type="text" id="l-user" class="input-box" placeholder="Username">
            <input type="password" id="l-pass" class="input-box" placeholder="Password">
            <button class="btn btn-primary" id="btn-login-action" onclick="auth.login()">LOGIN</button>
            <p class="text-xs" style="text-align:center; margin-top:15px; cursor:pointer; color:var(--text-muted);" onclick="location.href='mailto:forgotpass-espg@outlook.com?subject=Forgot Password&body=Please reset my password. My username is: '">Forgot Password?</p>
            <p style="text-align:center; margin-top:20px; font-size:13px; color:var(--text-muted)">New Player? <span style="color:var(--cyan); cursor:pointer" onclick="ui.toggleAuth('signup')">Create Account</span></p>
        </div>
        <div id="form-signup" class="hidden">
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn btn-outline" id="role-player" onclick="auth.setRole('player')" style="flex:1; border-color:var(--cyan); color:var(--cyan);">Player</button>
                <button class="btn btn-outline" id="role-organizer" onclick="auth.setRole('organizer')" style="flex:1;">Organizer</button>
            </div>
            <label>Country (Auto Currency)</label>
            <!-- REPLACED SELECT WITH CUSTOM TRIGGER -->
            <div class="input-box select-trigger" onclick="ui.openSelect('s-country', 'Select Country')">
                <span id="s-country-txt">USA ($ USD)</span>
                <span class="material-icons-round" style="color:var(--text-muted)">expand_more</span>
            </div>
            <select id="s-country" class="hidden">
                <option value="US">USA ($ USD)</option>
                <option value="IN">India (₹ INR)</option>
                <option value="EU">Europe (€ EUR)</option>
                <option value="UK">UK (£ GBP)</option>
                <option value="JP">Japan (¥ JPY)</option>
            </select>
            <label>Details</label>
            <input type="text" id="s-name" class="input-box" placeholder="Full Name">
            <input type="text" id="s-user" class="input-box" placeholder="Username (Unique)">
            <input type="email" id="s-email" class="input-box" placeholder="Email Address">
            <input type="tel" id="s-phone" class="input-box" placeholder="Phone Number">
            <input type="password" id="s-pass" class="input-box" placeholder="Password">
            <label>Referral Code (Optional)</label>
            <input type="text" id="s-refer" class="input-box" placeholder="Enter Friend's Username">
            <button class="btn btn-primary" id="btn-signup-action" onclick="auth.signup()">REGISTER</button>
            <p style="text-align:center; margin-top:20px; font-size:13px; color:var(--text-muted)">Have account? <span style="color:var(--cyan); cursor:pointer" onclick="ui.toggleAuth('login')">Login</span></p>
        </div>
    </div>

    <!-- APP -->
    <div id="view-app" class="hidden" style="height:100%; display:flex; flex-direction:column;">
        <header class="header">
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="width:36px; height:36px; background:var(--cyan); border-radius:10px; display:grid; place-items:center; font-weight:700; color:black;" id="nav-av">U</div>
                <div><div class="bold" style="font-size:14px; color:white;" id="nav-user">User</div><div class="text-xs" style="color:var(--cyan);" id="nav-role">PLAYER</div></div>
            </div>
            <div style="display:flex; align-items:center; gap:15px;">
                <div class="notif-icon" onclick="ui.router('notifications')">
                    <span class="material-icons-round" style="color:white;">notifications</span>
                    <div class="notif-dot" id="nav-notif"></div>
                </div>
                <div style="font-family:'Rajdhani'; font-weight:700; font-size:18px; color:var(--neon-green);" id="nav-bal">0.00</div>
            </div>
        </header>
        <div id="main-content" class="content"></div>
        <div id="fab" class="fab hidden" onclick="ui.router('create_match')"><span class="material-icons-round">add</span></div>
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="ui.router('home', this)"><span class="material-icons-round">grid_view</span>Home</div>
            <div class="nav-item" onclick="ui.router('leaderboard', this)"><span class="material-icons-round">leaderboard</span>Rank</div>
            <div class="nav-item" onclick="ui.router('wallet', this)"><span class="material-icons-round">account_balance_wallet</span>Wallet</div>
            <div class="nav-item hidden" id="menu-admin" onclick="ui.router('admin', this)"><span class="material-icons-round">admin_panel_settings</span>Admin</div>
            <div class="nav-item" onclick="ui.router('profile', this)"><span class="material-icons-round">person</span>Profile</div>
        </nav>
    </div>

    <!-- MODALS & OVERLAYS -->
    <div id="view-details" class="detail-view hidden"></div>
    <div id="modal-container"></div>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyBCkWyoKZXAP_TOaqQWdAhM_z_gr7d6H8k",
        authDomain: "esports-playground.firebaseapp.com",
        databaseURL: "https://esports-playground-default-rtdb.firebaseio.com",
        projectId: "esports-playground",
        storageBucket: "esports-playground.firebasestorage.app",
        messagingSenderId: "387918136520",
        appId: "1:387918136520:web:7aaabca5623cadd0a551fd",
        measurementId: "G-JQRJVL49V9"
    };

    try { firebase.initializeApp(firebaseConfig); var db = firebase.database(); } 
    catch (e) { alert("Firebase Error: " + e.message); }

    const state = { user: null, role: 'player', selectedFilter: 'All', selectedGame: 'All', leaderboardFilter: 'player' };
    const curMap = { 'IN': '₹', 'US': '$', 'EU': '€', 'UK': '£', 'JP': '¥', 'GL': '$' };
    const generateId = () => Math.floor(10000000000000 + Math.random() * 90000000000000).toString();
    const activeListeners = [];

    // --- AUTHENTICATION ---
    const auth = {
        setRole: (r) => {
            state.role = r;
            const btnP = document.getElementById('role-player'), btnO = document.getElementById('role-organizer');
            if(r === 'player') { btnP.style.borderColor = 'var(--cyan)'; btnP.style.color = 'var(--cyan)'; btnO.style.borderColor = 'var(--border)'; btnO.style.color = 'var(--text-muted)'; } 
            else { btnO.style.borderColor = 'var(--cyan)'; btnO.style.color = 'var(--cyan)'; btnP.style.borderColor = 'var(--border)'; btnP.style.color = 'var(--text-muted)'; }
        },
        signup: () => {
            const btn = document.getElementById('btn-signup-action'); btn.innerHTML = '...';
            const name = document.getElementById('s-name').value, user = document.getElementById('s-user').value.toLowerCase().trim(), pass = document.getElementById('s-pass').value;
            const country = document.getElementById('s-country').value;
            const referCode = document.getElementById('s-refer').value.toLowerCase().trim();
            
            if(!name || !user || !pass) { btn.innerHTML = 'REGISTER'; return ui.toast("Fill all fields"); }
            
            db.ref('users/' + user).once('value').then((snap) => {
                if(snap.exists()) { btn.innerHTML = 'REGISTER'; return ui.toast("Username taken!"); }
                
                // Referral Logic
                let startBal = 0;
                if(referCode) {
                    db.ref('users/' + referCode).once('value').then(rSnap => {
                        if(rSnap.exists()) {
                            // Bonus to Referrer
                            db.ref('users/' + referCode).update({ balance: rSnap.val().balance + 10 });
                            ui.sendNotif(referCode, "Referral Bonus: +10 Credits");
                            startBal = 5; // Bonus to New User
                        }
                    });
                }

                const newUser = { 
                    name, username: user, email: document.getElementById('s-email').value, 
                    phone: document.getElementById('s-phone').value, password: pass, 
                    role: state.role, balance: startBal, kycStatus: 'none', 
                    country: country, currency: curMap[country] || '$', 
                    joinedDate: new Date().toISOString(),
                    winnings: 0 
                };
                db.ref('users/' + user).set(newUser).then(() => { 
                    btn.innerHTML = 'REGISTER'; ui.toast("Created! Login."); ui.toggleAuth('login'); 
                });
            });
        },
        login: () => {
            const btn = document.getElementById('btn-login-action'); btn.innerHTML = '...';
            const user = document.getElementById('l-user').value.toLowerCase().trim(), pass = document.getElementById('l-pass').value;
            if(user === 'esportsplayground' && pass === 'vcxz888acxz888eSPG') {
                state.user = { username: 'admin', name: 'Super Admin', role: 'admin', balance: 999999, currency: '$', email:'admin@esp.com', phone:'0000000000', kycStatus:'verified' };
                localStorage.setItem('esp_session', JSON.stringify(state.user)); ui.initApp(); return;
            }
            db.ref('users/' + user).once('value').then((snap) => {
                if (snap.exists()) {
                    const d = snap.val();
                    if(d.password === pass) {
                        if(d.isBanned) { btn.innerHTML = 'LOGIN'; return ui.toast("Account Banned"); }
                        state.user = d; localStorage.setItem('esp_session', JSON.stringify(d)); ui.initApp();
                    } else { btn.innerHTML = 'LOGIN'; ui.toast("Wrong Password"); }
                } else { btn.innerHTML = 'LOGIN'; ui.toast("User not found"); }
            }).catch(e => { btn.innerHTML = 'LOGIN'; alert("Connection Error"); });
        },
        checkSession: () => {
            const s = localStorage.getItem('esp_session');
            if(s) { const u = JSON.parse(s); if(u.role === 'admin') { state.user = u; ui.initApp(); } else { db.ref('users/' + u.username).once('value').then(snap => { if(snap.exists()) { state.user = snap.val(); ui.initApp(); } }); } }
        },
        logout: () => { localStorage.removeItem('esp_session'); location.reload(); },
        resetPassword: () => { window.location.href = `mailto:esportsplayground@outlook.com?subject=Reset Password ${state.user.username}&body=Please reset my password.`; }
    };

    // --- UI MANAGER ---
    const ui = {
        toast: (msg) => {
            const t = document.createElement('div'); t.className = 'toast'; t.innerText = msg;
            document.getElementById('toast-area').appendChild(t); setTimeout(() => t.remove(), 3000);
        },
        sendNotif: (username, msg) => {
            db.ref('notifications/' + username).push({ msg: msg, date: new Date().toISOString(), read: false });
        },
        toggleAuth: (mode) => { document.getElementById('form-login').classList.toggle('hidden', mode !== 'login'); document.getElementById('form-signup').classList.toggle('hidden', mode !== 'signup'); },
        
        clearListeners: () => {
            activeListeners.forEach(l => l.ref.off('value', l.cb));
            activeListeners.length = 0;
        },
        addListener: (ref, callback) => {
            ref.on('value', callback);
            activeListeners.push({ ref: ref, cb: callback });
        },

        initApp: () => {
            document.getElementById('view-auth').classList.add('hidden'); document.getElementById('view-app').classList.remove('hidden');
            
            if(state.user.role !== 'admin') {
                // User Listener
                db.ref('users/' + state.user.username).on('value', snap => {
                    if(snap.exists()) {
                        state.user = snap.val();
                        document.getElementById('nav-user').innerText = state.user.name.split(' ')[0];
                        document.getElementById('nav-av').innerText = state.user.name[0];
                        document.getElementById('nav-bal').innerText = `${state.user.currency || '$'}${state.user.balance}`;
                    }
                });
                // Notif Listener
                db.ref('notifications/' + state.user.username).on('value', snap => {
                    let count = 0;
                    snap.forEach(n => { if(!n.val().read) count++; });
                    document.getElementById('nav-notif').style.display = count > 0 ? 'block' : 'none';
                });
            } else {
                document.getElementById('nav-user').innerText = "Admin";
                document.getElementById('nav-av').innerText = "A";
                document.getElementById('nav-bal').innerText = "ADM";
            }

            document.getElementById('nav-role').innerText = state.user.role.toUpperCase();
            if(state.user.role === 'organizer' || state.user.role === 'admin') document.getElementById('fab').classList.remove('hidden');
            if(state.user.role === 'admin') document.getElementById('menu-admin').classList.remove('hidden');
            ui.router('home');
        },
        router: (route, navEl = null) => {
            ui.clearListeners();
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            if(navEl) { navEl.classList.add('active'); }
            
            const c = document.getElementById('main-content'); c.innerHTML = '<div class="loader" style="margin-top:50px;"></div>';
            
            if(route === 'home') logic.loadHome(c);
            if(route === 'wallet') logic.loadWallet(c);
            if(route === 'admin') logic.loadAdmin(c, 'users');
            if(route === 'profile') logic.loadProfile(c);
            if(route === 'create_match') logic.loadCreate(c);
            if(route === 'leaderboard') logic.loadLeaderboardPage(c);
            if(route === 'notifications') logic.loadNotificationsPage(c);
            if(route === 'team_detail') logic.loadTeamDetailPage(c);
        },
        openModal: (type, data = null) => {
            const mc = document.getElementById('modal-container');
            let content = '';
            if(type === 'kyc') {
                content = `<h2 class="h2">Global KYC</h2><p class="text-xs" style="margin-bottom:15px;">Verify identity.</p><label>Legal Name</label><input id="k-name" class="input-box"><label>Payment</label><div class="input-box select-trigger" onclick="ui.openSelect('k-method', 'Select Method')"><span id="k-method-txt">PayPal</span><span class="material-icons-round" style="color:var(--text-muted)">expand_more</span></div><select id="k-method" class="hidden" onchange="ui.toggleKycFields()"><option value="paypal">PayPal</option><option value="upi">UPI</option><option value="bank">Bank Transfer</option></select><div id="sec-paypal"><label>Email</label><input id="k-pp-email" class="input-box"><label>Username</label><input id="k-pp-user" class="input-box"><label>Mobile</label><input id="k-pp-mobile" class="input-box"></div><div id="sec-upi" class="hidden"><label>UPI ID</label><input id="k-upi-id" class="input-box"><label>Mobile</label><input id="k-upi-mobile" class="input-box"></div><div id="sec-bank" class="hidden"><label>Bank Name</label><input id="k-bk-name" class="input-box"><label>Acc No</label><input id="k-bk-acc" class="input-box"><label>IFSC/SWIFT</label><input id="k-bk-code" class="input-box"></div><button class="btn btn-primary" onclick="logic.submitKyc()">SUBMIT</button><button class="btn btn-outline" style="margin-top:10px;" onclick="document.querySelector('.modal').remove()">CANCEL</button>`;
            } else if (type === 'deposit') {
                const autoId = generateId(); 
                content = `<h2 class="h2" style="text-align:center;">Scan & Pay</h2><div style="text-align:center; margin:20px 0;"><img src="https://i.postimg.cc/sXtr7zzk/e-Sports-Play-Ground.png" style="width:180px; border-radius:10px; border:2px solid var(--cyan);"><div style="background:#1f1f22; padding:10px; border-radius:8px; margin-top:10px; display:flex; justify-content:space-between; align-items:center;"><span class="text-xs" style="font-family:monospace">tusharkantidasofficial@oksbi</span><span class="bold text-xs" style="color:var(--cyan); cursor:pointer;" onclick="navigator.clipboard.writeText('tusharkantidasofficial@oksbi'); alert('Copied')">COPY</span></div></div><label>Amount (${state.user.currency})</label><input type="number" id="d-amt" class="input-box"><label>System Transaction ID (Auto)</label><input type="text" id="d-utr" class="input-box" value="${autoId}" disabled style="opacity:0.7; cursor:not-allowed;"><button class="btn btn-primary" onclick="logic.submitDeposit()">VERIFY</button><button class="btn btn-outline" style="margin-top:10px;" onclick="document.querySelector('.modal').remove()">CLOSE</button>`;
            } else if (type === 'organizerReward') {
                content = `<h2 class="h2">Reward Player</h2><label>Username</label><input id="rw-user" class="input-box"><label>Amount</label><input type="number" id="rw-amt" class="input-box"><button class="btn btn-primary" onclick="logic.giveReward()">SEND</button><button class="btn btn-outline" style="margin-top:10px;" onclick="document.querySelector('.modal').remove()">CANCEL</button>`;
            } else if (type === 'roomInfo') {
                content = `<h2 class="h2">Room Settings</h2><p class="text-xs" style="margin-bottom:15px;">Visible only to joined players when LIVE.</p><label>Room ID</label><input id="r-id" class="input-box" value="${data.roomId || ''}"><label>Password</label><input id="r-pass" class="input-box" value="${data.roomPass || ''}"><button class="btn btn-primary" onclick="logic.saveRoomInfo('${data.id}')">SAVE & UPDATE</button><button class="btn btn-outline" style="margin-top:10px;" onclick="document.querySelector('.modal').remove()">CANCEL</button>`;
            } else if (type === 'report') {
                content = `<h2 class="h2">Report Issue</h2><p class="text-xs" style="margin-bottom:15px;">Paste Match ID or Transaction ID</p><label>Issue Type</label><div class="input-box select-trigger" onclick="ui.openSelect('rep-type', 'Select Issue')"><span id="rep-type-txt">Match / Organizer Scam</span><span class="material-icons-round" style="color:var(--text-muted)">expand_more</span></div><select id="rep-type" class="hidden"><option value="match">Match / Organizer Scam</option><option value="payment">Payment Failure</option></select><label>Reference ID</label><input id="rep-id" class="input-box"><label>Description</label><input id="rep-desc" class="input-box"><button class="btn btn-primary" onclick="logic.submitReport()">SUBMIT REPORT</button><button class="btn btn-outline" style="margin-top:10px;" onclick="document.querySelector('.modal').remove()">CANCEL</button>`;
            } else if (type === 'teamCreate') {
                content = `<h2 class="h2">Create Team</h2><label>Team Name</label><input id="tm-name" class="input-box"><button class="btn btn-primary" onclick="logic.createTeam()">CREATE</button><button class="btn btn-outline" style="margin-top:10px;" onclick="document.querySelector('.modal').remove()">CANCEL</button>`;
            } else if (type === 'teamJoin') {
                content = `<h2 class="h2">Join Team</h2><label>Team Code</label><input id="tm-code" class="input-box"><button class="btn btn-primary" onclick="logic.joinTeam()">JOIN</button><button class="btn btn-outline" style="margin-top:10px;" onclick="document.querySelector('.modal').remove()">CANCEL</button>`;
            } else if (type === 'adminUserDetail') {
                const kyc = data.kycData || { method: 'None', linked: 'N/A' };
                let kycButtons = '';
                if (data.kycStatus === 'pending') {
                    kycButtons = `<div style="display:flex; gap:10px; margin-top:15px; border-top:1px solid #333; padding-top:15px;"><button class="btn btn-green" style="flex:1" onclick="logic.adminKycAction('${data.username}', 'approve')">APPROVE KYC</button><button class="btn btn-danger" style="flex:1" onclick="logic.adminKycAction('${data.username}', 'reject')">REJECT</button></div>`;
                }
                content = `<h2 class="h2">User Data: ${data.username}</h2><div style="height:350px; overflow-y:auto; margin-bottom:15px;"><div class="detail-item"><div class="detail-label">Full Name</div><div class="detail-val">${data.name}</div></div><div class="detail-item"><div class="detail-label">Financial</div><div class="detail-val">Method: ${kyc.method}<br>Link: ${kyc.linked}</div></div>${kycButtons}<label style="margin-top:15px;">Manage Balance</label><input type="number" id="adm-bal" class="input-box" value="${data.balance}"><button class="btn btn-primary" onclick="logic.adminUpdateUser('${data.username}')">UPDATE</button><button class="btn btn-danger" style="margin-top:10px;" onclick="logic.adminBan('${data.username}')">DELETE USER</button></div><button class="btn btn-outline" style="margin-top:10px;" onclick="document.querySelector('.modal').remove()">CLOSE</button>`;
            } else if (type === 'editProfile') {
                content = `<h2 class="h2">Edit Profile</h2><label>Full Name</label><input id="ep-name" class="input-box" value="${state.user.name}"><label>Mobile</label><input id="ep-phone" class="input-box" value="${state.user.phone}"><label>Email</label><input id="ep-email" class="input-box" value="${state.user.email}"><button class="btn btn-primary" onclick="logic.updateProfile()">SAVE CHANGES</button><button class="btn btn-outline" style="margin-top:10px;" onclick="document.querySelector('.modal').remove()">CANCEL</button>`;
            } else if (type === 'addGame') {
                content = `<h2 class="h2">Add Official Game</h2><label>Game Name</label><input id="ag-name" class="input-box"><label>Banner Image URL (9:16)</label><input id="ag-img" class="input-box" placeholder="https://..."><button class="btn btn-primary" onclick="logic.addGame()">ADD GAME</button><button class="btn btn-outline" style="margin-top:10px;" onclick="document.querySelector('.modal').remove()">CANCEL</button>`;
            }
            mc.innerHTML = `<div class="modal"><div class="modal-content"><div class="modal-handle"></div>${content}</div></div>`;
        },
        // --- CUSTOM SELECT LOGIC ---
        openSelect: (elemId, title) => {
            const sel = document.getElementById(elemId);
            const opts = Array.from(sel.options);
            const content = `
                <h3 class="h2" style="margin-bottom:15px">${title}</h3>
                <div style="max-height:300px; overflow-y:auto">
                    ${opts.map(o => `
                        <div class="select-option ${sel.value === o.value ? 'selected' : ''}" onclick="ui.confirmSelect('${elemId}', '${o.value}', '${o.text}')">
                            <span>${o.text}</span>
                            ${sel.value === o.value ? '<span class="material-icons-round" style="font-size:16px">check</span>' : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            const mc = document.getElementById('modal-container');
            mc.innerHTML = `<div class="modal"><div class="modal-content"><div class="modal-handle"></div>${content}</div></div>`;
        },
        confirmSelect: (elemId, val, text) => {
            const sel = document.getElementById(elemId);
            sel.value = val;
            const txt = document.getElementById(elemId + '-txt');
            if(txt) txt.innerText = text;
            if(sel.onchange) sel.onchange(); // Trigger change events
            document.querySelector('.modal').remove();
        },
        toggleKycFields: () => {
            const m = document.getElementById('k-method').value;
            document.getElementById('sec-paypal').classList.toggle('hidden', m !== 'paypal');
            document.getElementById('sec-upi').classList.toggle('hidden', m !== 'upi');
            document.getElementById('sec-bank').classList.toggle('hidden', m !== 'bank');
        },
        toggleBroadcastInput: () => {
            const t = document.getElementById('bc-type').value;
            document.getElementById('bc-user-div').classList.toggle('hidden', t === 'all');
            const input = document.getElementById('bc-user');
            input.placeholder = t === 'multiple' ? "username1, username2" : "Enter username";
        },
        closeDetails: () => document.getElementById('view-details').classList.add('hidden'),
        copyText: (t) => { navigator.clipboard.writeText(t); ui.toast("Copied!"); },
        toggleProfileEdit: () => {
            const inputs = document.querySelectorAll('.prof-in');
            const isDis = inputs[0].disabled;
            inputs.forEach(i => { if(i.id !== 'p-user') i.disabled = !isDis; });
            document.getElementById('btn-save-prof').classList.toggle('hidden', !isDis);
        }
    };

    const logic = {
        loadHome: (c) => {
            c.innerHTML = `
                <div class="search-container">
                    <div class="search-bar">
                        <span class="material-icons-round" style="color:var(--text-muted)">search</span>
                        <input id="search-input" class="search-input" placeholder="Search games..." onkeyup="logic.filterMatches()">
                    </div>
                    <div class="filter-scroll">
                        <div class="filter-chip active" onclick="logic.setFilter('All', this)">All</div>
                        <div class="filter-chip" onclick="logic.setFilter('Live', this)">Live</div>
                        <div class="filter-chip" onclick="logic.setFilter('Upcoming', this)">Upcoming</div>
                        <div class="filter-chip" onclick="logic.setFilter('Completed', this)">Completed</div>
                    </div>
                </div>
                <div id="game-slider" class="game-scroll"></div>
                <div id="match-list"></div>
            `;

            // Load Games
            db.ref('games').once('value').then(snap => {
                let html = `<div class="game-card ${state.selectedGame==='All'?'active':''}" onclick="logic.selectGameFilter('All', this)"><img src="https://i.postimg.cc/6pvtyPng/IMG-20251201-220945.png" style="opacity:0.5"><div class="game-name">ALL GAMES</div></div>`;
                snap.forEach(g => {
                    const v = g.val();
                    html += `<div class="game-card" onclick="logic.selectGameFilter('${v.name}', this)"><img src="${v.image}"><div class="game-name">${v.name}</div></div>`;
                });
                document.getElementById('game-slider').innerHTML = html;
            });

            ui.addListener(db.ref('tournaments').orderByChild('timestamp'), snap => {
                const arr = [];
                snap.forEach(i => { let t = i.val(); t.id = i.key; arr.unshift(t); });
                state.allMatches = arr;
                logic.filterMatches();
            });
        },
        filterMatches: () => {
            const query = document.getElementById('search-input').value.toLowerCase();
            const list = document.getElementById('match-list');
            const filtered = state.allMatches.filter(t => {
                const matchStatus = (state.selectedFilter === 'All' || t.status === state.selectedFilter);
                const matchGame = (state.selectedGame === 'All' || t.game === state.selectedGame);
                const matchSearch = t.title.toLowerCase().includes(query) || t.game.toLowerCase().includes(query) || t.creator.toLowerCase().includes(query);
                return matchStatus && matchSearch && matchGame;
            });
            if (filtered.length === 0) { list.innerHTML = `<div style="text-align:center; margin-top:50px; opacity:0.5;"><span class="material-icons-round" style="font-size:48px;">sports_esports</span><p class="text-sm">No matches found.</p></div>`; return; }
            list.innerHTML = filtered.map(t => {
                const isOfficial = t.creatorRole === 'admin';
                const offTag = isOfficial ? `<div class="official-tag">OFFICIAL</div>` : '';
                return `<div class="t-card" onclick="logic.openMatch('${t.id}')">${offTag}<img src="${t.img || 'https://via.placeholder.com/500x200'}" class="t-img"><div class="t-body"><div class="flex-between"><h3 class="h2">${t.title}</h3><span class="status-badge st-${t.status}">${t.status}</span></div><p class="text-xs" style="margin-top:4px;">${t.game} • ${t.creator}</p><div class="flex-between" style="margin-top:12px; border-top:1px solid var(--border); padding-top:10px;"><div class="text-xs"><span style="color:var(--cyan)">PRIZE</span><br><span class="bold" style="font-size:16px; color:white;">${t.currency||'$'}${t.prize}</span></div><div class="text-xs" style="text-align:right">ENTRY<br><span class="bold" style="font-size:14px; color:white;">${t.currency||'$'}${t.fee}</span></div></div></div></div>`;
            }).join('');
        },
        loadWallet: (c) => {
            const cur = state.user.currency || '$';
            c.innerHTML = `
                <div class="card" style="text-align:center; border-color:var(--cyan); box-shadow:var(--glow-cyan);">
                    <p class="text-xs" style="letter-spacing:1px; color:var(--cyan);">TOTAL BALANCE</p>
                    <h1 style="font-size:42px; margin:10px 0;">${cur}${state.user.balance}</h1>
                    ${state.user.kycStatus !== 'verified' ? `<div style="background:rgba(255,203,0,0.1); padding:10px; border-radius:8px; border:1px solid var(--yellow); margin-bottom:10px;"><p class="text-xs" style="color:var(--yellow)">⚠️ KYC Verification Pending</p></div><button class="btn btn-primary" onclick="ui.openModal('kyc')">COMPLETE KYC</button>` : `<div style="display:flex; gap:10px;"><button class="btn btn-outline" style="border-color:var(--cyan); color:var(--cyan)" onclick="ui.openModal('deposit')">ADD MONEY</button><button class="btn btn-outline" onclick="logic.withdraw()">WITHDRAW</button></div>`}
                </div>
                ${state.user.role === 'organizer' ? `<button class="btn btn-primary" style="margin:10px 0;" onclick="ui.openModal('organizerReward')">REWARD PLAYER</button>` : ''}
                <h3 class="h2" style="margin:20px 0 10px;">History</h3><div id="txn-list">Loading...</div>
            `;
            ui.addListener(db.ref('transactions'), snap => {
                const arr = []; snap.forEach(i => { if(i.val().user === state.user.username) { let v=i.val(); v.id=i.key; arr.unshift(v); } });
                document.getElementById('txn-list').innerHTML = arr.length ? arr.map(t => `<div class="card flex-between" style="padding:12px;"><div><div class="bold text-sm" style="color:white;">${t.type.toUpperCase()}</div><div class="text-xs" style="font-family:monospace; color:var(--text-muted)">ID: ${t.id}</div></div><div style="text-align:right"><div class="bold text-sm">${cur}${t.amount}</div><div class="text-xs" style="color:${t.status==='success'?'var(--neon-green)':(t.status==='rejected'?'var(--pink)':'var(--yellow)')}">${t.status}</div></div></div>`).join('') : '<p class="text-sm">No transactions.</p>';
            });
        },
        loadProfile: (c) => {
             if(state.user.role === 'admin') { c.innerHTML = `<h2 class="h1" style="margin-bottom:20px;">Admin Profile</h2><div class="card"><p class="bold">Super Admin</p><p class="text-xs">System Access Level: 10</p></div><button class="btn btn-danger" onclick="auth.logout()">LOGOUT</button>`; return; }
             
             // Check Team Status First
             db.ref('teams').orderByChild('members/' + state.user.username).equalTo(true).once('value').then(teamSnap => {
                 let hasTeam = teamSnap.exists();
                 let teamData = hasTeam ? Object.values(teamSnap.val())[0] : null;

                 ui.addListener(db.ref('users/' + state.user.username), snap => {
                     if(!snap.exists()) return;
                     state.user = snap.val();
                     db.ref('tournaments').once('value').then(tsnap => {
                         let joined = 0; tsnap.forEach(t => { if(t.val().participants && t.val().participants[state.user.username]) joined++; });
                         
                         let teamSectionHtml = '';
                         if(hasTeam) {
                             teamSectionHtml = `<button class="btn btn-primary" style="margin-bottom:15px; background:linear-gradient(45deg, var(--cyan), #009999); border:none; box-shadow:0 0 20px rgba(0,223,220,0.4);" onclick="ui.router('team_detail')">MY TEAM</button>`;
                         } else {
                             teamSectionHtml = `<div style="display:flex; gap:10px; margin-bottom:15px;"><button class="btn btn-outline" style="flex:1; color:var(--cyan); border-color:var(--cyan);" onclick="ui.openModal('teamCreate')">CREATE TEAM</button><button class="btn btn-outline" style="flex:1;" onclick="ui.openModal('teamJoin')">JOIN TEAM</button></div>`;
                         }

                         c.innerHTML = `
                            <h2 class="h1" style="margin-bottom:20px;">Profile</h2>
                            <div class="card" style="border:1px solid var(--cyan); box-shadow:var(--glow-cyan); background:linear-gradient(135deg, #111 0%, #002 100%);">
                                <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
                                    <div style="width:60px; height:60px; background:var(--cyan); border-radius:15px; color:black; display:grid; place-items:center; font-size:24px; font-weight:800;">${state.user.name[0]}</div>
                                    <div><div class="h2" style="margin:0; color:white;">${state.user.name}</div><div class="text-xs">@${state.user.username}</div>${state.user.kycStatus==='verified' ? '<span style="color:var(--neon-green); font-size:10px; font-weight:700;">VERIFIED ✓</span>' : '<span style="color:var(--pink); font-size:10px;">UNVERIFIED</span>'}</div>
                                </div>
                                <div class="flex-between" style="background:#000; padding:10px; border-radius:8px;">
                                    <div style="text-align:center;"><div class="bold text-sm">${joined}</div><div class="text-xs">Joined</div></div>
                                    <div style="text-align:center;"><div class="bold text-sm">${state.user.currency}${state.user.balance}</div><div class="text-xs">Wallet</div></div>
                                    <div style="text-align:center;"><div class="bold text-sm">${state.user.role}</div><div class="text-xs">Role</div></div>
                                </div>
                            </div>

                            ${teamSectionHtml}

                            <div class="settings-group">
                                <div class="menu-item" onclick="ui.router('leaderboard')"><div class="menu-label"><span class="material-icons-round" style="color:gold">leaderboard</span> Global Leaderboard</div><span class="material-icons-round" style="color:#666">chevron_right</span></div>
                                <div class="menu-item" onclick="ui.openModal('editProfile')"><div class="menu-label"><span class="material-icons-round" style="color:var(--cyan)">edit</span> Edit Details</div><span class="material-icons-round" style="color:#666">chevron_right</span></div>
                                <div class="menu-item" onclick="ui.openModal('kyc')"><div class="menu-label"><span class="material-icons-round" style="color:var(--neon-green)">verified</span> KYC Verification</div><span class="material-icons-round" style="color:#666">chevron_right</span></div>
                                <div class="menu-item" onclick="ui.openModal('report')"><div class="menu-label"><span class="material-icons-round" style="color:var(--yellow)">report</span> Report Issue</div><span class="material-icons-round" style="color:#666">chevron_right</span></div>
                                <div class="menu-item" onclick="auth.resetPassword()"><div class="menu-label"><span class="material-icons-round" style="color:var(--text-muted)">lock</span> Reset Password</div><span class="material-icons-round" style="color:#666">chevron_right</span></div>
                                <div class="menu-item" style="color:var(--pink)" onclick="auth.logout()"><div class="menu-label"><span class="material-icons-round">logout</span> Logout</div></div>
                            </div>
                         `;
                     });
                 });
             });
        },
        loadTeamDetailPage: (c) => {
            c.innerHTML = '<div class="loader"></div>';
            db.ref('teams').orderByChild('members/' + state.user.username).equalTo(true).once('value').then(snap => {
                if(!snap.exists()) { ui.router('profile'); return; }
                const tid = Object.keys(snap.val())[0];
                const t = snap.val()[tid];
                const isCreator = t.creator === state.user.username;
                const members = Object.keys(t.members);

                c.innerHTML = `
                    <div style="margin-bottom:20px; text-align:center;">
                        <span class="material-icons-round" style="font-size:48px; color:var(--cyan); margin-bottom:10px;">groups</span>
                        <h1 class="h1">${t.name}</h1>
                        <div style="background:#222; padding:8px 16px; border-radius:20px; display:inline-flex; align-items:center; gap:10px; margin-top:10px; cursor:pointer; border:1px solid #333;" onclick="ui.copyText('${t.code}')">
                            <span class="text-xs" style="color:#888;">TEAM CODE</span>
                            <span class="bold" style="color:white; letter-spacing:1px;">${t.code}</span>
                            <span class="material-icons-round" style="font-size:14px; color:var(--cyan)">content_copy</span>
                        </div>
                    </div>
                    
                    <h3 class="h2" style="margin-bottom:10px;">Members (${members.length})</h3>
                    <div class="card">
                        ${members.map(m => `
                            <div style="padding:10px; border-bottom:1px solid #222; display:flex; align-items:center; gap:10px;">
                                <div style="width:30px; height:30px; background:#222; border-radius:50%; display:grid; place-items:center; font-size:12px; font-weight:700;">${m[0].toUpperCase()}</div>
                                <div style="font-size:14px;">${m} ${m === t.creator ? '<span class="text-xs" style="color:var(--yellow); margin-left:5px;">(Owner)</span>' : ''}</div>
                            </div>
                        `).join('')}
                    </div>

                    <div style="margin-top:20px;">
                        ${isCreator ? 
                            `<button class="btn btn-danger" onclick="logic.deleteTeam('${tid}')">DELETE TEAM</button>` : 
                            `<button class="btn btn-danger" onclick="logic.leaveTeam('${tid}')">LEAVE TEAM</button>`
                        }
                    </div>
                    <button class="btn btn-outline" style="margin-top:10px;" onclick="ui.router('profile')">BACK</button>
                `;
            });
        },
        loadLeaderboardPage: (c) => {
            const filter = state.leaderboardFilter || 'player';
            
            c.innerHTML = `
                <div style="text-align:center; margin-bottom:10px;">
                    <h2 class="h1">Top Ranked</h2>
                    <p class="text-xs">Global Leaderboard</p>
                </div>
                
                <div class="filter-scroll" style="justify-content:center; margin-bottom:20px;">
                    <div class="filter-chip ${filter==='player'?'active':''}" onclick="state.leaderboardFilter='player'; logic.loadLeaderboardPage(document.getElementById('main-content'))">Players</div>
                    <div class="filter-chip ${filter==='organizer'?'active':''}" onclick="state.leaderboardFilter='organizer'; logic.loadLeaderboardPage(document.getElementById('main-content'))">Organizers</div>
                    <div class="filter-chip ${filter==='team'?'active':''}" onclick="state.leaderboardFilter='team'; logic.loadLeaderboardPage(document.getElementById('main-content'))">Teams</div>
                </div>

                <div id="podium-area" class="podium-container"></div>
                <div id="leader-list-page" style="padding-bottom:20px;">
                    <div class="loader"></div>
                </div>
            `;
            
            if(filter === 'team') {
                db.ref('teams').once('value').then(snap => {
                    const list = [];
                    snap.forEach(t => list.push(t.val()));
                    list.sort((a,b) => Object.keys(b.members||{}).length - Object.keys(a.members||{}).length);
                    
                    document.getElementById('podium-area').innerHTML = '';
                    let html = '';
                    if(list.length === 0) html = '<p class="text-sm" style="text-align:center">No teams found.</p>';
                    else {
                        list.forEach((t, i) => {
                            html += `<div class="leader-row"><div style="display:flex; gap:10px;"><span class="leader-rank">#${i+1}</span><span>${t.name}</span></div><span style="color:var(--text-muted); font-size:11px;">${Object.keys(t.members||{}).length} Members</span></div>`;
                        });
                    }
                    document.getElementById('leader-list-page').innerHTML = html;
                });
            } else {
                db.ref('users').orderByChild('balance').once('value').then(snap => {
                    const list = []; 
                    snap.forEach(u => {
                        const val = u.val();
                        if(val.role === filter) list.unshift(val);
                    });
                    
                    let podiumHtml = '';
                    if(list.length > 0) {
                        const top3 = [list[1], list[0], list[2]];
                        if(top3[0]) podiumHtml += `<div class="podium-item rank-2"><div class="podium-avatar">${top3[0].name[0]}</div><div class="podium-bar">2</div><div class="bold text-xs">${top3[0].name.split(' ')[0]}</div></div>`;
                        if(top3[1]) podiumHtml += `<div class="podium-item rank-1"><div class="podium-avatar">${top3[1].name[0]}</div><div class="podium-bar">1</div><div class="bold text-xs">${top3[1].name.split(' ')[0]}</div></div>`;
                        if(top3[2]) podiumHtml += `<div class="podium-item rank-3"><div class="podium-avatar">${top3[2].name[0]}</div><div class="podium-bar">3</div><div class="bold text-xs">${top3[2].name.split(' ')[0]}</div></div>`;
                    }
                    document.getElementById('podium-area').innerHTML = podiumHtml;

                    let html = '';
                    list.forEach((u, i) => { 
                        if(i > 2) {
                            html += `<div class="leader-row"><div style="display:flex; gap:10px;"><span class="leader-rank">#${i+1}</span><span>${u.name}</span></div><span style="color:var(--neon-green)">Top Ranked</span></div>`; 
                        }
                    });
                    document.getElementById('leader-list-page').innerHTML = html || '<p class="text-sm" style="text-align:center">No data found.</p>';
                });
            }
        },
        loadNotificationsPage: (c) => {
            c.innerHTML = `
                <div style="margin-bottom:20px;">
                    <h2 class="h1">Notifications</h2>
                    <p class="text-xs">Your latest updates</p>
                </div>
                <div id="notif-page-list">
                    <div class="loader"></div>
                </div>
            `;
            db.ref('notifications/' + state.user.username).once('value').then(snap => {
                let html = '';
                const updates = {};
                snap.forEach(n => {
                    const val = n.val();
                    const date = new Date(val.date).toLocaleString();
                    const unreadStyle = !val.read ? 'border-left: 3px solid var(--pink);' : '';
                    html = `<div class="card" style="padding:15px; ${unreadStyle}"><div class="text-sm" style="color:white; margin-bottom:5px;">${val.msg}</div><div class="text-xs text-muted">${date}</div></div>` + html;
                    if(!val.read) updates[n.key + '/read'] = true;
                });
                if(Object.keys(updates).length > 0) db.ref('notifications/' + state.user.username).update(updates);
                document.getElementById('notif-page-list').innerHTML = html || '<div style="text-align:center; padding:40px; opacity:0.5"><span class="material-icons-round" style="font-size:48px">notifications_none</span><p>No notifications yet.</p></div>';
            });
        },
        loadAdmin: (c, tab) => {
            if(state.user.role !== 'admin') return;
            const tabs = ['users', 'finance', 'kyc', 'reports', 'games', 'broadcast'];
            const tabUI = tabs.map(t => `<div class="admin-tab ${t===tab?'active':''}" onclick="logic.loadAdmin(document.getElementById('main-content'), '${t}')">${t.toUpperCase()}</div>`).join('');
            
            c.innerHTML = `
                <h2 class="h1" style="margin-bottom:20px;">Admin</h2>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button class="btn btn-primary" onclick="ui.router('create_match')">HOST MATCH</button>
                    <button class="btn btn-outline" onclick="ui.openModal('addGame')">ADD GAME</button>
                </div>
                <div class="admin-tabs">${tabUI}</div>
                <div id="adm-content"><div class="loader"></div></div>
            `;
            
            const cont = document.getElementById('adm-content');
            if(tab === 'users') {
                ui.addListener(db.ref('users'), snap => {
                    let html = `<div class="card"><div style="display:flex; gap:10px;"><input id="adm-search" class="input-box" placeholder="Search Username" style="margin-bottom:0;"><button class="btn btn-primary" style="width:auto;" onclick="logic.adminSearchUser()">GO</button></div></div>`;
                    snap.forEach(u => { 
                        const v = u.val(); 
                        if(v.username !== 'admin' && v.role !== 'admin' && v.username !== 'esportsplayground') {
                            html += `<div class="card flex-between"><div><div class="bold">${v.name}</div><div class="text-xs">@${v.username} | Bal: ${v.balance}</div></div><button class="btn btn-outline" style="padding:6px 12px; font-size:11px;" onclick='ui.openModal("adminUserDetail", ${JSON.stringify(v)})'>VIEW DATA</button></div>`;
                        }
                    });
                    cont.innerHTML = html;
                });
            } else if (tab === 'finance') {
                ui.addListener(db.ref('transactions').limitToLast(50), snap => {
                    let html = '';
                    snap.forEach(t => { const v = t.val(); v.id = t.key; if(v.status === 'pending') html += `<div class="card"><div class="flex-between"><span class="bold text-sm">${v.user}</span><span class="text-xs">${v.type}</span></div><div class="flex-between" style="margin:5px 0;"><span class="h2">Amt: ${v.amount}</span><span class="text-xs">ID:${v.id}</span></div><div style="display:flex; gap:10px;"><button class="btn btn-green" style="padding:8px; font-size:12px;" onclick="logic.adminTxn('${v.id}','approve','${v.user}',${v.amount},'${v.type}')">APPROVE</button><button class="btn btn-danger" style="padding:8px; font-size:12px;" onclick="logic.adminTxn('${v.id}','reject','${v.user}',${v.amount},'${v.type}')">REJECT</button></div></div>`; });
                    cont.innerHTML = html || '<p>No pending finance.</p>';
                });
            } else if (tab === 'kyc') {
                ui.addListener(db.ref('users').orderByChild('kycStatus').equalTo('pending'), snap => {
                    let html = '';
                    snap.forEach(u => { const v = u.val(); html += `<div class="card"><div class="bold text-sm">${v.name} (@${v.username})</div><div class="text-xs" style="margin:5px 0; color:var(--text-muted);">Method: ${v.kycData.method}</div><button class="btn btn-primary" style="padding:8px; font-size:12px;" onclick='ui.openModal("adminUserDetail", ${JSON.stringify(v)})'>REVIEW DATA</button></div>`; });
                    cont.innerHTML = html || '<p>No pending KYC.</p>';
                });
            } else if (tab === 'reports') {
                ui.addListener(db.ref('reports'), snap => {
                    let html = '';
                    snap.forEach(r => { const v = r.val(); v.id = r.key; html += `<div class="card"><div class="bold text-sm text-pink">Type: ${v.type}</div><div class="text-xs">Ref: ${v.refId}<br>By: ${v.by}<br>Desc: ${v.desc}</div><button class="btn btn-outline" style="margin-top:5px; padding:6px;" onclick="logic.delReport('${v.id}')">RESOLVE</button></div>`; });
                    cont.innerHTML = html || '<p>No reports.</p>';
                });
            } else if (tab === 'games') {
                ui.addListener(db.ref('games'), snap => {
                    let html = '';
                    snap.forEach(g => { const v = g.val(); html += `<div class="card flex-between"><img src="${v.image}" style="width:40px;height:70px;object-fit:cover;border-radius:4px;"><div style="flex:1; margin-left:10px;"><div class="bold">${v.name}</div></div><button class="btn btn-danger" style="padding:4px 10px; font-size:10px;" onclick="logic.delGame('${g.key}')">DELETE</button></div>`; });
                    cont.innerHTML = html || '<p>No games added.</p>';
                });
            } else if (tab === 'broadcast') {
                cont.innerHTML = `
                    <div class="card">
                        <h3 class="h2" style="margin-bottom:15px;">Send Notification</h3>
                        <label>Target Audience</label>
                        <div class="input-box select-trigger" onclick="ui.openSelect('bc-type', 'Select Audience')">
                            <span id="bc-type-txt">All Users (Broadcast)</span>
                            <span class="material-icons-round" style="color:var(--text-muted)">expand_more</span>
                        </div>
                        <select id="bc-type" class="hidden" onchange="ui.toggleBroadcastInput()">
                            <option value="all">All Users (Broadcast)</option>
                            <option value="single">Single User</option>
                            <option value="multiple">Multiple Users</option>
                        </select>
                        <div id="bc-user-div" class="hidden">
                            <label>Username(s)</label>
                            <input id="bc-user" class="input-box" placeholder="Enter username">
                        </div>
                        <label>Message Content</label>
                        <textarea id="bc-msg" class="input-box" style="height:100px; resize:none;" placeholder="Type your message here..."></textarea>
                        <button class="btn btn-primary" id="btn-bc-send" onclick="logic.adminSendBroadcast()">SEND NOTIFICATION</button>
                    </div>
                `;
            }
        },
        loadCreate: (c) => {
            const cur = state.user.currency || '$';
            
            // Fetch Games List for Dropdown
            db.ref('games').once('value').then(snap => {
                let assets = '';
                snap.forEach(g => {
                    const v = g.val();
                    assets += `<div class="asset-card" onclick="ui.selectGame('${v.name}', '${v.image}', this)"><img src="${v.image}" class="asset-img"><div class="asset-name">${v.name}</div></div>`;
                });
                
                c.innerHTML = `
                    <h2 class="h1" style="margin-bottom:20px;">Host Match</h2>
                    <label>Select Official Game Asset</label>
                    <div class="asset-grid">${assets || '<p class="text-sm">No games found. Admin must add games first.</p>'}</div>
                    <label>Match Title</label><input id="c-title" class="input-box">
                    <label>Rules & Info</label><input id="c-desc" class="input-box">
                    <div style="display:flex; gap:10px;"><div style="flex:1"><label>Fee (${cur})</label><input type="number" id="c-fee" class="input-box"></div><div style="flex:1"><label>Prize (${cur})</label><input type="number" id="c-prize" class="input-box"></div></div>
                    <label>Max Players</label><input type="number" id="c-max" class="input-box" value="100">
                    <label>Schedule</label><input type="datetime-local" id="c-date" class="input-box">
                    <label>Status</label>
                    <div class="input-box select-trigger" onclick="ui.openSelect('c-status', 'Select Status')"><span id="c-status-txt">Upcoming</span><span class="material-icons-round" style="color:var(--text-muted)">expand_more</span></div>
                    <select id="c-status" class="hidden"><option>Upcoming</option><option>Live</option></select>
                    <button class="btn btn-primary" onclick="logic.createMatch()">PUBLISH MATCH</button>
                `;
            });
        },
        // --- ACTIONS & ROOM LOGIC ---
        addGame: () => {
            const name = document.getElementById('ag-name').value;
            const img = document.getElementById('ag-img').value;
            if(!name || !img) return ui.toast("Fill details");
            db.ref('games').push({ name, image: img });
            ui.toast("Game Added"); document.querySelector('.modal').remove();
        },
        delGame: (id) => { db.ref('games/'+id).remove(); },
        saveRoomInfo: (id) => {
            const rid = document.getElementById('r-id').value, rpass = document.getElementById('r-pass').value;
            db.ref('tournaments/' + id).update({ roomId: rid, roomPass: rpass });
            ui.toast("Room Updated"); document.querySelector('.modal').remove(); logic.openMatch(id);
            // Notify Users
            db.ref('tournaments/' + id + '/participants').once('value').then(snap => {
                snap.forEach(p => ui.sendNotif(p.key, "Room ID Updated for Match"));
            });
        },
        submitReport: () => {
            const type = document.getElementById('rep-type').value, id = document.getElementById('rep-id').value, desc = document.getElementById('rep-desc').value;
            if(!id || !desc) return ui.toast("Fill details");
            db.ref('reports').push({ type, refId: id, desc, by: state.user.username, date: new Date().toISOString() });
            ui.toast("Report Sent"); document.querySelector('.modal').remove();
        },
        delReport: (id) => { db.ref('reports/' + id).remove(); },
        updateProfile: () => {
            const updates = { name: document.getElementById('ep-name').value, phone: document.getElementById('ep-phone').value, email: document.getElementById('ep-email').value };
            db.ref('users/' + state.user.username).update(updates); state.user = { ...state.user, ...updates }; ui.toast("Updated"); document.querySelector('.modal').remove(); ui.router('profile');
        },
        adminUpdateUser: (u) => {
            const bal = parseFloat(document.getElementById('adm-bal').value);
            db.ref('users/' + u).update({ balance: bal });
            ui.toast("Updated"); document.querySelector('.modal').remove();
        },
        adminKycAction: (username, action) => {
            const status = action === 'approve' ? 'verified' : 'rejected';
            db.ref('users/' + username).update({ kycStatus: status });
            ui.toast(`KYC ${status.toUpperCase()}`);
            document.querySelector('.modal').remove();
        },
        submitKyc: () => {
            const m = document.getElementById('k-method').value;
            let data = { method: m };
            if (m === 'paypal') { data.email = document.getElementById('k-pp-email').value; data.user = document.getElementById('k-pp-user').value; data.mobile = document.getElementById('k-pp-mobile').value; }
            else if (m === 'upi') { data.upi = document.getElementById('k-upi-id').value; data.mobile = document.getElementById('k-upi-mobile').value; }
            else { data.bank = document.getElementById('k-bk-name').value; data.acc = document.getElementById('k-bk-acc').value; data.code = document.getElementById('k-bk-code').value; }
            data.linked = data.email || data.upi || data.acc;
            db.ref('users/' + state.user.username).update({ kycStatus: 'pending', kycData: data }); state.user.kycStatus = 'pending'; ui.toast("KYC Submitted"); document.querySelector('.modal').remove(); ui.router('wallet');
        },
        submitDeposit: () => {
            const amt = parseFloat(document.getElementById('d-amt').value), utr = document.getElementById('d-utr').value; // Auto-Generated UTR
            if(!amt || !utr) return ui.toast("Fill details");
            db.ref('transactions/' + utr).set({ user: state.user.username, type: 'deposit', amount: amt, utr: 'Auto-Gen', status: 'pending', date: new Date().toISOString() }); ui.toast("Sent!"); document.querySelector('.modal').remove();
        },
        withdraw: () => {
            const amt = parseFloat(prompt("Amount:")); if(!amt || amt > state.user.balance) return ui.toast("Invalid Amount");
            const newBal = state.user.balance - amt; db.ref('users/' + state.user.username).update({ balance: newBal }); state.user.balance = newBal;
            const txnId = generateId();
            db.ref('transactions/' + txnId).set({ user: state.user.username, type: 'withdraw', amount: amt, utr: 'Requested', status: 'pending', date: new Date().toISOString() }); ui.router('wallet'); ui.toast("Requested");
        },
        createTeam: () => {
            const name = document.getElementById('tm-name').value;
            if(!name) return ui.toast("Enter Team Name");
            const code = Math.random().toString(36).substring(2, 8).toUpperCase();
            const t = { name, code, members: {} };
            t.members[state.user.username] = true;
            db.ref('teams').push(t);
            ui.toast("Team Created!"); document.querySelector('.modal').remove(); logic.loadProfile(document.getElementById('main-content'));
        },
        joinTeam: () => {
            const code = document.getElementById('tm-code').value.toUpperCase().trim();
            db.ref('teams').orderByChild('code').equalTo(code).once('value').then(snap => {
                if(snap.exists()) {
                    let tid; snap.forEach(t => tid = t.key);
                    db.ref(`teams/${tid}/members/${state.user.username}`).set(true);
                    ui.toast("Joined Team!"); document.querySelector('.modal').remove(); logic.loadProfile(document.getElementById('main-content'));
                } else ui.toast("Invalid Code");
            });
        },
        createMatch: () => {
            if(!state.selectedGameName || !state.selectedGameImg) return ui.toast("Select a Game Asset");
            const cur = state.user.currency || '$';
            const m = { 
                title: document.getElementById('c-title').value, game: state.selectedGameName, 
                img: state.selectedGameImg, desc: document.getElementById('c-desc').value, 
                fee: parseInt(document.getElementById('c-fee').value), prize: parseInt(document.getElementById('c-prize').value), 
                maxPlayers: parseInt(document.getElementById('c-max').value), timestamp: firebase.database.ServerValue.TIMESTAMP,
                schedule: document.getElementById('c-date').value,
                status: document.getElementById('c-status').value, creator: state.user.username, creatorRole: state.user.role, 
                currency: cur, participants: {} 
            };
            const matchId = generateId();
            db.ref('tournaments/' + matchId).set(m); ui.toast("Published"); ui.router('home');
        },
        // --- MATCH OPEN LOGIC ---
        openMatch: (id) => {
            ui.addListener(db.ref('tournaments/' + id), snap => {
                const t = snap.val(); const v = document.getElementById('view-details'); v.classList.remove('hidden');
                const parts = t.participants ? Object.keys(t.participants) : [];
                const isJoined = parts.includes(state.user.username), isOwner = state.user.username === t.creator || state.user.role === 'admin';
                const cur = t.currency || '$';
                const isFull = parts.length >= (t.maxPlayers || 100);
                const isOfficial = t.creatorRole === 'admin';
                
                let roomHtml = '';
                if(isJoined && t.roomId) {
                    roomHtml = `<div class="room-box"><div class="text-xs" style="color:var(--cyan); margin-bottom:10px;">SECRET ROOM DETAILS</div><div class="room-row"><span>ID:</span><span class="room-val">${t.roomId}</span><button class="btn-copy" onclick="ui.copyText('${t.roomId}')">COPY</button></div><div class="room-row"><span>PASS:</span><span class="room-val">${t.roomPass}</span><button class="btn-copy" onclick="ui.copyText('${t.roomPass}')">COPY</button></div></div>`;
                } else if(isJoined && !t.roomId) { roomHtml = `<div class="card" style="border:1px dashed #444; color:#777; text-align:center; font-size:12px;">Room info appears when LIVE.</div>`; }

                const matchIdDisplay = `<div style="background:#222; padding:10px; border-radius:8px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;"><span class="text-xs text-muted">Match ID: ${id}</span><button class="btn-copy" onclick="ui.copyText('${id}')">COPY</button></div>`;
                
                const dateFull = t.schedule ? new Date(t.schedule).toLocaleString() : 'Date: TBA';

                v.innerHTML = `
                    <div style="position:fixed; top:20px; left:20px; z-index:70; background:rgba(0,0,0,0.6); padding:8px; border-radius:50%; cursor:pointer;" onclick="ui.closeDetails()"><span class="material-icons-round" style="color:white;">arrow_back</span></div>
                    <div class="detail-header">${isOfficial ? `<div class="official-tag">OFFICIAL</div>` : ''}<img src="${t.img || 'https://via.placeholder.com/500x300'}" class="detail-img"><div style="position:absolute; bottom:20px; left:20px;"><span class="status-badge st-${t.status}">${t.status}</span><h1 class="h1" style="margin-top:5px; text-shadow:0 2px 4px rgba(0,0,0,0.8);">${t.title}</h1></div></div>
                    
                    <div id="tab-info" style="padding:20px; padding-bottom:100px;">
                        ${matchIdDisplay}
                        <div class="flex-between" style="margin-bottom:20px;"><div class="text-xs">Organizer: <span class="bold" style="color:white">${t.creator}</span></div></div>
                        ${roomHtml}
                        <div class="detail-item"><div class="detail-label">Schedule</div><div class="detail-val">${dateFull}</div></div>
                        <p class="text-sm" style="color:white; margin-bottom:20px;">${t.desc || 'No rules.'}</p>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;"><div class="card" style="text-align:center;"><div class="text-xs">ENTRY</div><div class="bold" style="color:var(--cyan)">${cur}${t.fee}</div></div><div class="card" style="text-align:center;"><div class="text-xs">PRIZE</div><div class="bold" style="color:var(--neon-green)">${cur}${t.prize}</div></div></div>
                        <h3 class="h2">Participants (${parts.length}/${t.maxPlayers || '∞'})</h3>
                        <div style="margin-top:10px;">${parts.length ? parts.map(p => `<div style="padding:8px; border-bottom:1px solid #222; font-size:14px;">${p}</div>`).join('') : '<p class="text-xs">No participants.</p>'}</div>
                        ${isOwner ? `
                            <hr style="border:0; border-top:1px solid #333; margin:20px 0;"><label>Admin Control</label>
                            <div style="display:flex; gap:10px; margin-bottom:10px;">
                                <button class="btn btn-outline" onclick="logic.updateMatchStatus('${id}', 'Upcoming')">Upcoming</button>
                                <button class="btn btn-outline" onclick="logic.updateMatchStatus('${id}', 'Live')">Live</button>
                                <button class="btn btn-outline" onclick="logic.updateMatchStatus('${id}', 'Completed')">End</button>
                            </div>
                            <button class="btn btn-primary" style="margin-bottom:10px;" onclick="ui.openModal('roomInfo', {id:'${id}', roomId:'${t.roomId||''}', roomPass:'${t.roomPass||''}'})">UPDATE ROOM ID/PASS</button>
                            <button class="btn btn-danger" onclick="logic.deleteMatch('${id}')">DELETE MATCH</button>
                        `:''}
                        ${isJoined ? `
                            <hr style="border:0; border-top:1px solid #333; margin:20px 0;"><label>Winner Proof</label>
                            <div style="display:flex; gap:10px;">
                                <input id="res-url" class="input-box" placeholder="Screenshot URL" style="margin:0;">
                                <button class="btn btn-primary" style="width:auto;" onclick="logic.uploadResult('${id}')">SEND</button>
                            </div>
                        ` : ''}
                    </div>

                    <div style="position:fixed; bottom:0; width:100%; padding:20px; background:rgba(10,10,10,0.95); border-top:1px solid var(--border); max-width:500px;">
                        ${isJoined ? `<button class="btn btn-danger" onclick="logic.joinMatch('${id}', ${t.fee}, false, '${t.creator}')">LEAVE MATCH</button>` : 
                          (isFull ? `<button class="btn btn-grey">MATCH FULL</button>` : `<button class="btn btn-green" onclick="logic.joinMatch('${id}', ${t.fee}, true, '${t.creator}', ${t.maxPlayers}, ${parts.length})">JOIN MATCH (${cur}${t.fee})</button>`)
                        }
                    </div>
                `;
            });
        },
        toggleMatchTab: (tab) => { },
        sendMessage: (id) => { },
        uploadResult: (id) => {
            const url = document.getElementById('res-url').value;
            if(!url) return ui.toast("Enter URL");
            db.ref('match_results/' + id).push({ user: state.user.username, url: url });
            ui.toast("Proof Uploaded");
        },
        joinMatch: (id, fee, joining, creatorId, max, current) => {
            if(joining) {
                if(current >= max) return ui.toast("Match Full");
                if(state.user.balance < fee) return ui.toast("Low Balance");
                if(!confirm(`Join for ${fee}?`)) return;
                const playerBal = state.user.balance - fee;
                db.ref('users/' + state.user.username).update({ balance: playerBal }); state.user.balance = playerBal;
                db.ref('users/' + creatorId).once('value').then(s => { if(s.exists()) db.ref('users/' + creatorId).update({ balance: s.val().balance + fee }); });
                db.ref(`tournaments/${id}/participants/${state.user.username}`).set(true);
                const txnId = generateId();
                db.ref('transactions/' + txnId).set({ user: state.user.username, type: 'match_join', amount: fee, matchId: id, status: 'success', date: new Date().toISOString() });
                ui.toast("Joined!");
            } else { if(!confirm("Leave?")) return; db.ref(`tournaments/${id}/participants/${state.user.username}`).remove(); ui.toast("Left"); }
            ui.closeDetails(); ui.router('home');
        },
        adminSearchUser: (usernameOverride) => {
            const u = usernameOverride || document.getElementById('adm-search').value.toLowerCase().trim();
            db.ref('users/' + u).once('value').then(s => { if(s.exists()) ui.openModal('adminUserDetail', s.val()); else ui.toast("Not found"); });
        },
        adminUpdateUser: (u) => {
            const bal = parseFloat(document.getElementById('adm-bal').value);
            db.ref('users/' + u).update({ balance: bal });
            ui.toast("Updated"); document.querySelector('.modal').remove();
        },
        adminBan: (u) => { if(confirm("Delete User?")) { db.ref('users/' + u).remove(); ui.toast("Deleted"); document.querySelector('.modal').remove(); } },
        adminTxn: (id, act, u, amt, type) => {
            db.ref('users/' + u).once('value').then(s => {
                const c = s.val().balance;
                if(act === 'approve' && type === 'deposit') db.ref('users/' + u).update({ balance: c + amt });
                if(act === 'reject' && type === 'withdraw') db.ref('users/' + u).update({ balance: c + amt });
                db.ref('transactions/' + id).update({ status: act === 'approve' ? 'success' : 'rejected' });
                ui.router('admin', 'finance');
            });
        },
        adminSendBroadcast: () => {
             const type = document.getElementById('bc-type').value;
             const msg = document.getElementById('bc-msg').value;
             if(!msg) return ui.toast("Enter a message");

             const checkAndSend = (u) => {
                 db.ref('users/' + u).once('value').then(s => {
                     if(s.exists()) {
                         ui.sendNotif(u, "Admin: " + msg);
                     }
                 });
             };

             if(type === 'single') {
                 const u = document.getElementById('bc-user').value.toLowerCase().trim();
                 if(!u) return ui.toast("Enter username");
                 checkAndSend(u);
                 ui.toast("Sent if user exists");
                 document.getElementById('bc-msg').value = '';
             } else if (type === 'multiple') {
                 const targets = document.getElementById('bc-user').value;
                 if(!targets) return ui.toast("Enter usernames");
                 const users = targets.split(',').map(u => u.trim().toLowerCase()).filter(u => u);
                 users.forEach(u => checkAndSend(u));
                 ui.toast("Processing list...");
                 document.getElementById('bc-msg').value = '';
             } else {
                 if(!confirm("Send to ALL users?")) return;
                 const btn = document.getElementById('btn-bc-send');
                 btn.innerText = "Sending...";
                 btn.disabled = true;

                 db.ref('users').once('value').then(snap => {
                     snap.forEach(u => { ui.sendNotif(u.key, "📢 " + msg); });
                     ui.toast("Broadcast Sent!");
                     btn.innerText = "SEND NOTIFICATION";
                     btn.disabled = false;
                     document.getElementById('bc-msg').value = '';
                 });
             }
        },
        updateMatchStatus: (id, s) => { db.ref('tournaments/' + id).update({ status: s }); ui.closeDetails(); ui.router('home'); },
        deleteMatch: (id) => { if(confirm("Delete?")) { db.ref('tournaments/' + id).remove(); ui.closeDetails(); ui.router('home'); } },
        giveReward: () => {
            const u = document.getElementById('rw-user').value.toLowerCase().trim(), amt = parseFloat(document.getElementById('rw-amt').value);
            if(!u || !amt) return ui.toast("Invalid details");
            db.ref('users/' + u).once('value').then(s => { if(s.exists()) { db.ref('users/' + u).update({ balance: s.val().balance + amt }); ui.toast("Sent!"); document.querySelector('.modal').remove(); } else ui.toast("User not found"); });
        },
        selectGame: (name, img, el) => {
            state.selectedGameName = name;
            state.selectedGameImg = img;
            document.querySelectorAll('.asset-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        },
        setFilter: (filter, el) => {
            state.selectedFilter = filter;
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            logic.filterMatches();
        },
        selectGameFilter: (game, el) => {
            state.selectedGame = game;
            document.querySelectorAll('.game-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            logic.filterMatches();
        }
    };

    window.onload = auth.checkSession;
</script>
</body>
</html>